function [T,J,model]=tpvec(coeffs,x0,model,params,c0,nep,P,varargin)

% This function computes the nonlinear system of Taylor projection and the
% Jacobian for n_s different systems.
% Input args:  coeffs=Polynomial coefficients (denoted Theta in the paper).
%              The coefficients should be provided as a vector of unique Taylor
%              coefficients.
%              x0=point at which the system is evaluated
%              model=variable generated by prepare_tp
%              params=parameters of the model
%              eta=the matrix eta
%              c0=center of the power series.
%              nep=a matrix of the realizations of the shocks. each row is a different shock.
%              P=a vector of probabilities (weights) of each realization.
%              varargin=option to add precomputed variables that are independent of coeffs.
% Output args: T=a vector of the model conditions and the derivatives.
%              J=Jacobian of T.
%              model=the variable model updated.
% 
% © Copyright, Oren Levintal, October 3, 2016.
% changed on January 26, 2017 - extended to fourth order

if model.steady_state==1
    x0(1:model.n_x1)=coeffs(model.n_y+(1:model.n_x1));
    c0=x0;
end


ms=0; % no Markov Switching
if ~isempty(varargin)
    coeffsp=varargin{1};
    if ~isempty(coeffsp)
        ms=1; % Markov Switching model
    end
end

order=model.order(1);

if numel(x0)==model.n_x && numel(coeffs)==model.n_theta && numel(params)==model.n_params
    n_s=1;
else % x0,coeffs,params have a row dimension of 1 or n_s
    temp=[size(x0,1),size(coeffs,1),size(params,1),size(c0,1)];
    n_s=max(temp);
    if min(temp)~=n_s
        error('incompatible s dimension')
    end
end


% make sure all inputs are full
coeffsvec=full(reshape(coeffs,n_s,model.n_theta));
x0vec=full(reshape(x0,n_s,model.n_x));
paramsvec=full(reshape(params,n_s,model.n_params));

if model.hybrid==1 || model.hybrid==3
    paramsvec=[zeros(n_s,model.n_e),paramsvec];
end
% eta=full(eta);
uname=['eta' model.uname '_fun'];
etavec=feval(uname,paramsvec,[]);
etavec=reshape(full(etavec),n_s*model.n_x,[]); % this function is nonzero only if model.hybrid==0

c0vec=full(reshape(c0,n_s,model.n_x));
nep=full(nep);
P=full(P);



if ~isequal(c0vec,x0vec) % center must be equal to x0
    error('power series must be centered at x0')
end

x0=x0vec(1,:); x0=x0(:);
c0=c0vec(1,:); c0=c0(:);

if ~isfield(model,'jacobian')
    model.jacobian='exact';
else
    if ~strcmp(model.jacobian,'approximate')
        model.jacobian='exact';
    end
    if isfield(model,'indtype')
        if ~strcmp(model.jacobian,model.indtype)
            model=rmfield(model,'ind');
            if isfield(model,'ind4')
                model=rmfield(model,'ind4');
            end
        end
    end
end
model.indtype=model.jacobian;

% if model.pde==2 % in this version there are y and tily. tily are the unknown variables of the algorithm (their number is n_tily), but y are the original n_y model variables, approximated the projection y=Amat*tily
%     old_n_y=model.n_y;
%     model.n_y=model.n_tily;
%     [ g_theta,h_theta,gx_theta,hx_theta,gxxc_theta,hxxc_theta,gxxxc_theta,hxxxc_theta,gxxxxc_theta,hxxxxc_theta,model ] = precompute(x0,c0,model,order ); 
%     model.n_y=old_n_y;
% else
    [ g_theta,h_theta,gx_theta,hx_theta,gxxc_theta,hxxc_theta,gxxxc_theta,hxxxc_theta,gxxxxc_theta,hxxxxc_theta,model ] = precompute(x0,c0,model,order ); 
% end

g_theta.vals=repmat(g_theta.vals,n_s,1);
h_theta.vals=repmat(h_theta.vals,n_s,1);
if order>=1
    gx_theta.vals=repmat(gx_theta.vals,n_s,1);
    hx_theta.vals=repmat(hx_theta.vals,n_s,1);
end
if order>=2
    gxxc_theta.vals=repmat(gxxc_theta.vals,n_s,1);
    hxxc_theta.vals=repmat(hxxc_theta.vals,n_s,1);
end
if order>=3
    gxxxc_theta.vals=repmat(gxxxc_theta.vals,n_s,1);
    hxxxc_theta.vals=repmat(hxxxc_theta.vals,n_s,1);
end
if order>=4
    gxxxxc_theta.vals=repmat(gxxxxc_theta.vals,n_s,1);
    hxxxxc_theta.vals=repmat(hxxxxc_theta.vals,n_s,1);
end

if ms==1
    g_theta.tsize(end)=model.n_theta*2; % in ms models we duplicate the Jacobian. The first block corresponds to coefficients of current period, and the second block to next period.
    h_theta.tsize(end)=model.n_theta*2;
    if order>=1
        gx_theta.tsize(end)=model.n_theta*2;
        hx_theta.tsize(end)=model.n_theta*2;
    end
    if order>=2
        gxxc_theta.tsize(end)=model.n_theta*2;
        hxxc_theta.tsize(end)=model.n_theta*2;
    end
    if order>=3
        gxxxc_theta.tsize(end)=model.n_theta*2;
        hxxxc_theta.tsize(end)=model.n_theta*2;
    end
    if order>=4
        gxxxxc_theta.tsize(end)=model.n_theta*2;
        hxxxxc_theta.tsize(end)=model.n_theta*2;
    end
end


indi=5; %count indi from 5, due to precompute.


if ~isfield(model,'n_ind')
    n_ind=1;
else
    n_ind=model.n_ind;
end
if ~isfield(model,'maxload')
    maxload=intarray(length(P)*n_s);
else
    maxload=intarray(model.maxload);
end
model.maxload=maxload;

params=paramsvec;
P=P(:);

n_f=model.n_f; % no. of model conditions
n_x=model.n_x; % no. of state variables
n_y=model.n_y; % no. of control variables
n_x2=model.n_x2; % no. of exogenous state variables
n_x1=model.n_x1; % no. of endogenous state variabels
n_v=model.n_v; % total no. of variables v=(yp,y,xp,x)
n_theta=model.n_theta; % no. of Polynomial coefficients
n_b=model.n_b; % no. of terms in the basis function
n_nodes=size(nep,2); % no. nodes in the discrete shocks
n_z=model.n_z; % no. of auxiliary variables
n_e=model.n_e;

n_prefrows=length(model.prefrows);
n_stochfrows=length(model.stochfrows);

n_params=model.n_params;

if model.hybrid==1 || model.hybrid==3
    n_params=n_params+n_e; % shocks are treated as parameters
end

coeffs=reshape(coeffsvec,n_s,[],n_b);
% g_coeffs=coeffs(:,1:n_y,:);

%create stochy: index of future control variables that affect stochastic equations
tempv=zeros(n_v,1);
tempv(model.stochfvars)=model.stochfvars;
tempv(n_y+1:end)=0;
stochy=nonzeros(tempv); % this is the stochastic y variables that affect f, but it does not include stochastic y variables that affect logical expressions only
n_stochy=length(stochy);
if ms==0
    stochg_coeffs=coeffs(:,stochy,:); 
else
    coeffspvec=full(reshape(coeffsp,n_s,[],n_b));
    stochg_coeffs=coeffspvec(:,stochy,:); 
end

if ~isfield(model,'ind4')
    model.ind4=cell(100+model.count_pre_n+model.count_stoch_n,1); % indices for 4th order computations
end
indi4=1;

unique2=[]; unique3=[]; unique4=[];

prefvars=model.prefvars; % index of variables that affect nonstochastic equations.
stochfvars=model.stochfvars;% index of variables that affect stochastic equations.
n_prefvars=length(prefvars);
n_stochfvars=length(stochfvars);

if model.pde==3 % compute derivatives of derivs w.r.t x and theta
    factor=ms+1; 
    if order==0
        gx__theta=sptensor(model.n_tildy1st,n_theta*factor,n_s);
    else
        rows=1:model.n_tildy1st;
        rows=rows(:);
        cols=n_y+(model.tildy1st_ind);
        cols=cols(:);
        vals=ones(n_s,length(rows));
        gx__theta=sptensor(rows,cols,vals,model.n_tildy1st,n_theta*factor);
    end
    if order<=1
        gxx__theta=sptensor(model.n_tildy2nd,n_theta*factor,n_s);
    else
        rows=1:model.n_tildy2nd;
        rows=rows(:);
        cols=n_y+n_y*n_x+(1:n_y*model.unique2);
        cols=full(reshape(cols,n_y,model.unique2)*model.W{2});
        cols=cols(model.tildy2nd_ind);
        cols=cols(:);
        vals=2*ones(n_s,length(rows));
        gxx__theta=sptensor(rows,cols,vals,model.n_tildy2nd,n_theta*factor);
    end
    gx__theta=vconcat(gxx__theta,gx__theta);
    g_theta=vconcat(gx__theta,g_theta); % derivatives and levels
    if order>=1
        if order==1
            gx_x_theta=sptensor(model.n_tildy1st,[n_x,n_theta*factor],n_s);
        else
            rows=1:model.n_tildy1st*n_x;
            cols=n_y+n_y*n_x+(1:n_y*model.unique2);
            cols=full(reshape(cols,n_y,model.unique2)*model.W{2});
            cols=reshape(cols,n_y*n_x,n_x);
            cols=cols(model.tildy1st_ind,:);
            [rows1,rows2]=ind2sub([model.n_tildy1st,n_x],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=2*ones(n_s,length(rows));
            gx_x_theta=sptensor(rows,cols,vals,model.n_tildy1st,[n_x,n_theta*factor]);
        end
        if order<=2
            gxx_x_theta=sptensor(model.n_tildy2nd,[n_x,n_theta*factor],n_s);
        else
            rows=1:model.n_tildy2nd*n_x;
            rows=rows(:);
            cols=n_y+n_y*n_x+n_y*model.unique2+(1:n_y*model.unique3);
            cols=full(reshape(cols,n_y,model.unique3)*model.W{3});
            cols=reshape(cols,n_y*n_x^2,n_x);
            cols=cols(model.tildy2nd_ind,:);
            cols=cols(:);
            [rows1,rows2]=ind2sub([model.n_tildy2nd,n_x],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=6*ones(n_s,length(rows));
            gxx_x_theta=sptensor(rows,cols,vals,model.n_tildy2nd,[n_x,n_theta*factor]);
        end
        gx_x_theta=vconcat(gxx_x_theta,gx_x_theta);
        gx_theta=vconcat(gx_x_theta,gx_theta);
    end
    if order>=2
        if order==2
            gx_xxc_theta=sptensor(model.n_tildy1st,[model.unique2,n_theta*factor],n_s);
        else
            rows=1:model.n_tildy1st*model.unique2;
            cols=n_y+n_y*n_x+n_y*model.unique2+(1:n_y*model.unique3);
            cols=full(reshape(cols,n_y,model.unique3)*model.W{3});
            cols=reshape(cols,n_y*n_x,n_x^2);
            cols=cols(model.tildy1st_ind,:);
            cols=full(cols*model.U{2});
            
            [rows1,rows2]=ind2sub([model.n_tildy1st,model.unique2],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=6*ones(n_s,length(rows));
            gx_xxc_theta=sptensor(rows,cols,vals,model.n_tildy1st,[model.unique2,n_theta*factor]);
        end
        if order<=3
            gxx_xxc_theta=sptensor(model.n_tildy2nd,[model.unique2,n_theta*factor],n_s);
        else
            rows=1:model.n_tildy2nd*model.unique2;
            rows=rows(:);
            cols=n_y+n_y*n_x+n_y*model.unique2+n_y*model.unique3+(1:n_y*model.unique4);
            cols=full(reshape(cols,n_y,model.unique4)*model.W{4});
            cols=full(reshape(cols,n_y*n_x^2,n_x^2)*model.U{2});
            cols=cols(model.tildy2nd_ind,:);
            cols=cols(:);
            [rows1,rows2]=ind2sub([model.n_tildy2nd,model.unique2],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=24*ones(n_s,length(rows));
            gxx_xxc_theta=sptensor(rows,cols,vals,model.n_tildy2nd,[model.unique2,n_theta*factor]);
        end
        gx_xxc_theta=vconcat(gxx_xxc_theta,gx_xxc_theta);
        gxxc_theta=vconcat(gx_xxc_theta,gxxc_theta);
    end
    if order>=3
        if order==3
            gx_xxxc_theta=sptensor(model.n_tildy1st,[model.unique3,n_theta*factor],n_s);
        else
            rows=1:model.n_tildy1st*model.unique3;
            cols=n_y+n_y*(n_x+model.unique2+model.unique3)+(1:n_y*model.unique4);
            cols=full(reshape(cols,n_y,model.unique4)*model.W{4});
            cols=reshape(cols,n_y*n_x,n_x^3);
            cols=cols(model.tildy1st_ind,:);
            cols=full(cols*model.U{3});
            
            [rows1,rows2]=ind2sub([model.n_tildy1st,model.unique3],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=24*ones(n_s,length(rows));
            gx_xxxc_theta=sptensor(rows,cols,vals,model.n_tildy1st,[model.unique3,n_theta*factor]);
        end
        if order<=4
            gxx_xxxc_theta=sptensor(model.n_tildy2nd,[model.unique3,n_theta*factor],n_s);
        else
            error('order cannot exceed 4')
        end
        gx_xxxc_theta=vconcat(gxx_xxxc_theta,gx_xxxc_theta);
        gxxxc_theta=vconcat(gx_xxxc_theta,gxxxc_theta);
    end
    if order>=4
        if order==4
            gx_xxxxc_theta=sptensor(model.n_tildy1st,[model.unique4,n_theta*factor],n_s);
            gxx_xxxxc_theta=sptensor(model.n_tildy2nd,[model.unique4,n_theta*factor],n_s);
        else
            error('order cannot exceed 4')
        end
        gx_xxxxc_theta=vconcat(gxx_xxxxc_theta,gx_xxxxc_theta);
        gxxxxc_theta=vconcat(gx_xxxxc_theta,gxxxxc_theta);
    end
    if model.pde>=2
        if model.pde==2
            AmatT=feval('AmatT_d1',zeros(n_s,n_y*(1+n_x)),params,model.Amat_ind);
        elseif model.pde==3
            AmatT=feval('AmatT_d1',zeros(n_s,n_y+model.n_tildy1st+model.n_tildy2nd),params,model.Amat_ind);
        end
        g_theta=contraction1(AmatT,g_theta);
        if order>=1
            gx_theta=contraction1(AmatT,unfold(gx_theta));
            gx_theta=fold(gx_theta,n_x,n_theta*factor);
        end
        if order>=2
            gxxc_theta=contraction1(AmatT,unfold(gxxc_theta));
            gxxc_theta=fold(gxxc_theta,model.unique2,n_theta*factor);
        end
        if order>=3
            gxxxc_theta=contraction1(AmatT,unfold(gxxxc_theta));
            gxxxc_theta=fold(gxxxc_theta,model.unique3,n_theta*factor);
        end
        if order>=4
            gxxxxc_theta=contraction1(AmatT,unfold(gxxxxc_theta));
            gxxxxc_theta=fold(gxxxxc_theta,model.unique4,n_theta*factor);
        end
    end
elseif model.pde>=1 % compute derivatives of dy w.r.t x and theta
    factor=ms+1; 
    if order==0
        gx__theta=sptensor(n_y*n_x,n_theta*factor,n_s);
    else
        rows=1:n_y*n_x;
        rows=rows(:);
        cols=n_y+(1:n_y*n_x);
        cols=cols(:);
        vals=ones(n_s,length(rows));
        gx__theta=sptensor(rows,cols,vals,n_y*n_x,n_theta*factor);
    end
    g_theta=vconcat(gx__theta,g_theta); % derivatives and levels
    if order>=1
        if order==1
            gx_x_theta=sptensor(n_y*n_x,[n_x,n_theta*factor],n_s);
        else
            rows=1:n_y*n_x^2;
            cols=n_y+n_y*n_x+(1:n_y*model.unique2);
            cols=full(reshape(cols,n_y,model.unique2)*model.W{2});
            [rows1,rows2]=ind2sub([n_y*n_x,n_x],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=2*ones(n_s,length(rows));
            gx_x_theta=sptensor(rows,cols,vals,n_y*n_x,[n_x,n_theta*factor]);
        end
        gx_theta=vconcat(gx_x_theta,gx_theta);
    end
    if order>=2
        if order==2
            gx_xxc_theta=sptensor(n_y*n_x,[model.unique2,n_theta*factor],n_s);
        else
            rows=1:n_y*n_x*model.unique2;
            cols=n_y+n_y*n_x+n_y*model.unique2+(1:n_y*model.unique3);
            cols=full(reshape(cols,n_y,model.unique3)*model.W{3});
            cols=reshape(cols,n_y*n_x,n_x^2);
            cols=full(cols*model.U{2});
            
            [rows1,rows2]=ind2sub([n_y*n_x,model.unique2],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=6*ones(n_s,length(rows));
            gx_xxc_theta=sptensor(rows,cols,vals,n_y*n_x,[model.unique2,n_theta*factor]);
        end
        gxxc_theta=vconcat(gx_xxc_theta,gxxc_theta);
    end
    if order>=3
        if order==3
            gx_xxxc_theta=sptensor(n_y*n_x,[model.unique3,n_theta*factor],n_s);
        else
            rows=1:n_y*n_x*model.unique3;
            cols=n_y+n_y*(n_x+model.unique2+model.unique3)+(1:n_y*model.unique4);
            cols=full(reshape(cols,n_y,model.unique4)*model.W{4});
            cols=reshape(cols,n_y*n_x,n_x^3);
            cols=full(cols*model.U{3});
            
            [rows1,rows2]=ind2sub([n_y*n_x,model.unique3],rows(:));
            rows=rows1(:);
            cols=[rows2(:),cols(:)];
            vals=24*ones(n_s,length(rows));
            gx_xxxc_theta=sptensor(rows,cols,vals,n_y*n_x,[model.unique3,n_theta*factor]);
        end
        gxxxc_theta=vconcat(gx_xxxc_theta,gxxxc_theta);
    end
    if order>=4
        if order==4
            gx_xxxxc_theta=sptensor(n_y*n_x,[model.unique4,n_theta*factor],n_s);
        else
            error('order cannot exceed 4')
        end
        gxxxxc_theta=vconcat(gx_xxxxc_theta,gxxxxc_theta);
    end
    if model.pde==2
        AmatT=feval('AmatT_d1',zeros(n_s,n_y*(1+n_x)),params,model.Amat_ind);

        g_theta=contraction1(AmatT,g_theta);
        if order>=1
            gx_theta=contraction1(AmatT,unfold(gx_theta));
            gx_theta=fold(gx_theta,n_x,n_theta*factor);
        end
        if order>=2
            gxxc_theta=contraction1(AmatT,unfold(gxxc_theta));
            gxxc_theta=fold(gxxc_theta,model.unique2,n_theta*factor);
        end
        if order>=3
            gxxxc_theta=contraction1(AmatT,unfold(gxxxc_theta));
            gxxxc_theta=fold(gxxxc_theta,model.unique3,n_theta*factor);
        end
        if order>=4
            gxxxxc_theta=contraction1(AmatT,unfold(gxxxxc_theta));
            gxxxxc_theta=fold(gxxxxc_theta,model.unique4,n_theta*factor);
        end
    end
end
% lower block of v_theta, vx_theta and so on
v_theta_lower_terms=vconcat(vconcat(g_theta,h_theta),sptensor(n_x,(ms+1)*n_theta,n_s));
if order>=1
    vx_theta_lower_terms=vconcat(vconcat(gx_theta,hx_theta),sptensor(n_x,[n_x,(ms+1)*n_theta],n_s));
end
if order>=2
    unique2=model.unique2;
    vxxc_theta_lower_terms=vconcat(vconcat(gxxc_theta,hxxc_theta),sptensor(n_x,[unique2,(ms+1)*n_theta],n_s));
end
if order>=3
    unique3=model.unique3;
    vxxxc_theta_lower_terms=vconcat(vconcat(gxxxc_theta,hxxxc_theta),sptensor(n_x,[unique3,(ms+1)*n_theta],n_s));
end
if order>=4
    unique4=model.unique4;
    vxxxxc_theta_lower_terms=vconcat(vconcat(gxxxxc_theta,hxxxxc_theta),sptensor(n_x,[unique4,(ms+1)*n_theta],n_s));
end



% current state
nx=x0vec;

% evaluate policy functions
% if model.pde==2
%     n_y=model.n_tily;
% end

g=coeffs(:,1:n_y,1);% only constant term is nonzero
h1=coeffs(:,n_y+1:end,1);
h=zeros(n_s,n_x);

% derivatives of policy functions at x0 (assuming c0=x0)
if order>=1
    gx=coeffs(:,1:n_y,2:1+n_x);
    if model.pde==3
        if order==1
            gx_x=sptensor(model.n_tildy1st,n_x,n_s);
            gxx_x=sptensor(model.n_tildy2nd,n_x,n_s);
            gx_x=vconcat(gxx_x,gx_x);
        end
    elseif model.pde>=1
        if order==1
            gx_x=sptensor(n_y*n_x,n_x,n_s);
        end
    end
    tempT=sptensor(reshape(gx(1,:,:),n_y,n_x));
    tempT.vals=reshape(permute(gx,[1,3,2]),n_s,n_x*n_y); % permute is needed because tensors are in row format
    gx=tempT;
    
    
    h1x=coeffs(:,n_y+1:end,2:1+n_x);
    tempT=sptensor(reshape(h1x(1,:,:),n_x1,n_x));
    tempT.vals=reshape(permute(h1x,[1,3,2]),n_s,n_x*n_x1); % permute is needed because tensors are in row format
    h1x=tempT;
end

if order>=2
    gxxc=coeffs(:,1:n_y,2+n_x:1+n_x+unique2)*2;
    if model.pde==3
        gx_x=full(reshape(gxxc,n_s*n_y,unique2)*model.W{2});
        gx_x=reshape(gx_x,n_s,n_y*n_x,n_x);
        gx_x=gx_x(:,model.tildy1st_ind,:);
        tempT=sptensor(reshape(gx_x(1,:,:),model.n_tildy1st,n_x));
        tempT.vals=reshape(permute(gx_x,[1,3,2]),n_s,n_x*model.n_tildy1st); % permute is needed because tensors are in row format
        gx_x=tempT;
        if order==2
            gx_xxc=sptensor(model.n_tildy1st,unique2,n_s);
            gxx_x=sptensor(model.n_tildy2nd,n_x,n_s);
            gxx_xxc=sptensor(model.n_tildy2nd,unique2,n_s);
            gx_x=vconcat(gxx_x,gx_x);
            gx_xxc=vconcat(gxx_xxc,gx_xxc);
            
        end
    elseif model.pde>=1
        gx_x=full(reshape(gxxc,n_s*n_y,unique2)*model.W{2});
        gx_x=reshape(gx_x,n_s,n_y*n_x,n_x);
        tempT=sptensor(reshape(gx_x(1,:,:),n_y*n_x,n_x));
        tempT.vals=reshape(permute(gx_x,[1,3,2]),n_s,n_x*n_y*n_x); % permute is needed because tensors are in row format
        gx_x=tempT;
        if order==2
            gx_xxc=sptensor(n_y*n_x,unique2,n_s);
        end
    end
    tempT=sptensor(reshape(gxxc(1,:,:),n_y,unique2));
    tempT.vals=reshape(permute(gxxc,[1,3,2]),n_s,unique2*n_y); % permute is needed because tensors are in row format
    gxxc=tempT;
    
    h1xxc=coeffs(:,n_y+1:end,2+n_x:1+n_x+unique2)*2;
    tempT=sptensor(reshape(h1xxc(1,:,:),n_x1,unique2));
    tempT.vals=reshape(permute(h1xxc,[1,3,2]),n_s,unique2*n_x1); % permute is needed because tensors are in row format
    h1xxc=tempT;
end
if order>=3
    gxxxc=coeffs(:,1:n_y,2+n_x+unique2:1+n_x+unique2+unique3)*6;
    if model.pde==3
        gx_xx=full(reshape(gxxxc,n_s*n_y,unique3)*model.W{3});
        gx_xx=reshape(gx_xx,n_s*n_y*n_x,n_x^2);
        gx_xxc=full(gx_xx*model.U{2});
        gx_xxc=reshape(gx_xxc,n_s,n_y*n_x,unique2);
        gx_xxc=gx_xxc(:,model.tildy1st_ind,:);
        tempT=sptensor(reshape(gx_xxc(1,:,:),model.n_tildy1st,unique2));
        tempT.vals=reshape(permute(gx_xxc,[1,3,2]),n_s,unique2*model.n_tildy1st); % permute is needed because tensors are in row format
        gx_xxc=tempT;

        gxx_x=full(reshape(gxxxc,n_s*n_y,unique3)*model.W{3});
        gxx_x=reshape(gxx_x,n_s,n_y*n_x^2,n_x);
        gxx_x=gxx_x(:,model.tildy2nd_ind,:);
        tempT=sptensor(reshape(gxx_x(1,:,:),model.n_tildy2nd,n_x));
        tempT.vals=reshape(permute(gxx_x,[1,3,2]),n_s,n_x*model.n_tildy2nd); % permute is needed because tensors are in row format
        gxx_x=tempT;
        
        if order==3
            gx_xxxc=sptensor(model.n_tildy1st,unique3,n_s);
            gxx_xxc=sptensor(model.n_tildy2nd,unique2,n_s);
            gxx_xxxc=sptensor(model.n_tildy2nd,unique3,n_s);
            gx_x=vconcat(gxx_x,gx_x);
            gx_xxc=vconcat(gxx_xxc,gx_xxc);
            gx_xxxc=vconcat(gxx_xxxc,gx_xxxc);
       end
    elseif model.pde>=1
        gx_xx=full(reshape(gxxxc,n_s*n_y,unique3)*model.W{3});
        gx_xxc=full(reshape(gx_xx,n_s*n_y*n_x,n_x^2)*model.U{2});
        gx_xxc=reshape(gx_xxc,n_s,n_y*n_x,unique2);
        tempT=sptensor(reshape(gx_xxc(1,:,:),n_y*n_x,unique2));
        tempT.vals=reshape(permute(gx_xxc,[1,3,2]),n_s,unique2*n_y*n_x); % permute is needed because tensors are in row format
        gx_xxc=tempT;
        if order==3
            gx_xxxc=sptensor(n_y*n_x,unique3,n_s);
        end
    end
    tempT=sptensor(reshape(gxxxc(1,:,:),n_y,unique3));
    tempT.vals=reshape(permute(gxxxc,[1,3,2]),n_s,unique3*n_y); % permute is needed because tensors are in row format
    gxxxc=tempT;
    
    h1xxxc=coeffs(:,n_y+1:end,2+n_x+unique2:1+n_x+unique2+unique3)*6;
    tempT=sptensor(reshape(h1xxxc(1,:,:),n_x1,unique3));
    tempT.vals=reshape(permute(h1xxxc,[1,3,2]),n_s,unique3*n_x1); % permute is needed because tensors are in row format
    h1xxxc=tempT;
end
if order>=4
    gxxxxc=coeffs(:,1:n_y,2+n_x+unique2+unique3:1+n_x+unique2+unique3+unique4)*24;
    if model.pde==3
        gx_xxx=full(reshape(gxxxxc,n_s*n_y,unique4)*model.W{4});
        gx_xxx=reshape(gx_xxx,n_s*n_y*n_x,n_x^3);
        gx_xxxc=full(gx_xxx*model.U{3});
        gx_xxxc=reshape(gx_xxxc,n_s,n_y*n_x,unique3);
        gx_xxxc=gx_xxxc(:,model.tildy1st_ind,:);
        tempT=sptensor(reshape(gx_xxxc(1,:,:),model.n_tildy1st,unique3));
        tempT.vals=reshape(permute(gx_xxxc,[1,3,2]),n_s,unique3*model.n_tildy1st); % permute is needed because tensors are in row format
        gx_xxxc=tempT;

        gxx_xx=full(reshape(gxxxxc,n_s*n_y,unique4)*model.W{4});
        gxx_xx=reshape(gxx_xx,n_s*n_y*n_x^2,n_x^2);
        gxx_xxc=full(gxx_xx*model.U{2});
        gxx_xxc=reshape(gxx_xxc,n_s,n_y*n_x^2,unique2);
        gxx_xxc=gxx_xxc(:,model.tildy2nd_ind,:);
        tempT=sptensor(reshape(gxx_xxc(1,:,:),model.n_tildy2nd,unique2));
        tempT.vals=reshape(permute(gxx_xxc,[1,3,2]),n_s,unique2*model.n_tildy2nd); % permute is needed because tensors are in row format
        gxx_xxc=tempT;
        
        if order==4
            gx_xxxxc=sptensor(model.n_tildy1st,unique4,n_s);
            gxx_xxxc=sptensor(model.n_tildy2nd,unique3,n_s);
            gxx_xxxxc=sptensor(model.n_tildy2nd,unique4,n_s);
            gx_x=vconcat(gxx_x,gx_x);
            gx_xxc=vconcat(gxx_xxc,gx_xxc);
            gx_xxxc=vconcat(gxx_xxxc,gx_xxxc);
            gx_xxxxc=vconcat(gxx_xxxxc,gx_xxxxc);
        end
    elseif model.pde>=1
        gx_xxx=full(reshape(gxxxxc,n_s*n_y,unique4)*model.W{4});
        gx_xxxc=full(reshape(gx_xxx,n_s*n_y*n_x,n_x^3)*model.U{3});
        gx_xxxc=reshape(gx_xxxc,n_s,n_y*n_x,unique3);
        tempT=sptensor(reshape(gx_xxxc(1,:,:),n_y*n_x,unique3));
        tempT.vals=reshape(permute(gx_xxxc,[1,3,2]),n_s,unique3*n_y*n_x); % permute is needed because tensors are in row format
        gx_xxxc=tempT;
        if order==4
            gx_xxxxc=sptensor(n_y*n_x,unique4,n_s);
        end
    end
    tempT=sptensor(reshape(gxxxxc(1,:,:),n_y,unique4));
    tempT.vals=reshape(permute(gxxxxc,[1,3,2]),n_s,unique4*n_y); % permute is needed because tensors are in row format
    gxxxxc=tempT;
    
    h1xxxxc=coeffs(:,n_y+1:end,2+n_x+unique2+unique3:1+n_x+unique2+unique3+unique4)*24;
    tempT=sptensor(reshape(h1xxxxc(1,:,:),n_x1,unique4));
    tempT.vals=reshape(permute(h1xxxxc,[1,3,2]),n_s,unique4*n_x1); % permute is needed because tensors are in row format
    h1xxxxc=tempT;
end
% control vars
if model.pde==0
    ny=g;
elseif model.pde==3
    if order==0
        ny=full([zeros(1,model.n_tildy2nd+model.n_tildy1st),g]);
    elseif order==1
        temp=reshape(permute(reshape(gx.vals,n_s,n_x,n_y),[1,3,2]),n_s,n_y*n_x);
        temp=temp(:,model.tildy1st_ind);
        ny=full([zeros(n_s,model.n_tildy2nd),temp,g]);
    elseif order>=2
        temp1=reshape(permute(reshape(gx.vals,n_s,n_x,n_y),[1,3,2]),n_s,n_y*n_x);
        temp1=temp1(:,model.tildy1st_ind);
        temp2=reshape(permute(reshape(gxxc.vals,n_s,unique2,n_y),[1,3,2]),n_s*n_y,unique2);
        temp2=full(temp2*model.W{2});
        temp2=reshape(temp2,n_s,n_y*n_x^2);
        temp2=temp2(:,model.tildy2nd_ind);
        ny=full([temp2,temp1,g]);
    end
else
    if order==0
        ny=full([zeros(1,n_y*n_x),g]);
    else
        ny=full([reshape(permute(reshape(gx.vals,n_s,n_x,n_y),[1,3,2]),n_s,n_y*n_x),g]);
    end
end

if model.pde>=2
%     n_y=old_n_y;
    tildy_tily=ny;
    if model.pde==2
        tildy_tilyT=sptensor(zeros(n_y*(1+n_x),1));
    else
        tildy_tilyT=sptensor(zeros(n_y+model.n_tildy1st+model.n_tildy2nd,1));
    end
    tildy_tilyT.vals=tildy_tily;
    nyT=contraction1(AmatT,tildy_tilyT); % this is the vector of the original [dy;y]
    ny=nyT.vals;
end
% STEP 1: COMPUTE NONSTOCHASTIC EQUATIONS AND DERIVATIVES, AND THEIR JACOBIAN

% build h(x)
h(:,1:n_x1,1)=h1; % predetermined endogenous state vars

if model.hybrid==0
    uname=['Phi' model.uname '_fun'];
    h(:,n_x1+1:end,1)=feval(uname,nx,params); % expected value of exogenous state vars. shocks are added later

    % derivatives of h at x0
    if order>=1
        hx=vconcat(h1x,Phi_d_c1(nx,params,model.Phi_indc));
    end
    if order>=2
        hxxc=vconcat(h1xxc,Phi_d_c2(nx,params,model.Phi_indc));
    end
    if order>=3
        hxxxc=vconcat(h1xxxc,Phi_d_c3(nx,params,model.Phi_indc));
    end
    if order>=4
        hxxxxc=vconcat(h1xxxxc,Phi_d_c4(nx,params,model.Phi_indc));
    end
else
    % derivatives of h at x0
    if order>=1
        hx=vconcat(h1x,sptensor(n_x2,n_x,n_s));
    end
    if order>=2
        hxxc=vconcat(h1xxc,sptensor(n_x2,model.unique2,n_s));
    end
    if order>=3
        hxxxc=vconcat(h1xxxc,sptensor(n_x2,model.unique3,n_s));
    end
    if order>=4
        hxxxxc=vconcat(h1xxxxc,sptensor(n_x2,model.unique4,n_s));
    end    
end

% expected value of next period state variables.
nxp=h;

% evaluate residuals R0
if model.pde==0
    nv=[zeros(n_s,n_y),ny,nxp,nx]; % model variables, yp are zero for now, and nxp is an expected value. stochastic components will be added later.
elseif model.pde==1
    nv=[zeros(n_s,n_y*(n_x+1)),ny,nxp,nx];
elseif model.pde>=2
    nv=[zeros(n_s,model.n_y_extended),ny,nxp,nx];
end

n_u=model.n_u;
nu=zeros(n_s,n_u);
uname=['preu' model.uname '_fun'];
npreu=feval(uname,nv(:,model.preuvars),params); % all predetermined u
nu(:,model.preurows)=npreu;

% This block is not necessary, because f is independent of x2p (they are treated
% as auxiliary variables and substituted out)
% if model.hybrid==1
%     nxp(:,n_x1+1:end)=nu(:,end-n_x2+1:end); % last block of auxiliary variables are the hybrid state variables
%     nv=[zeros(n_s,n_y),ny,nxp,nx];
% end

nz=[nv,nu]; % auxiliary variables
params(:,model.logical_params_loc)=double(logical(nz(:,model.logical_zvars)>0));

if isempty(model.prefrows)
    preR0=sptensor(0,1,n_s);
    preR1=sptensor(0,n_x,n_s);
    preR2=sptensor(0,unique2,n_s);
    preR3=sptensor(0,unique3,n_s);
    preR4=sptensor(0,unique4,n_s);
    preJ0=sptensor(0,(ms+1)*n_theta,n_s);
    preJ1=sptensor(0,[n_x,(ms+1)*n_theta],n_s);
    preJ2=sptensor(0,[unique2,(ms+1)*n_theta],n_s);
    preJ3=sptensor(0,[unique3,(ms+1)*n_theta],n_s);
    preJ4=sptensor(0,[unique4,(ms+1)*n_theta],n_s);
    
    % compute variables that will be necessary later
    uname=['prePI' model.uname '_d1'];

    prePIz_full=feval(uname,nz,params,model.prePI_ind_u);
    if order>=1
        uname=['prePI' model.uname '_d2'];
        prePIzz_full=feval(uname,nz,params,model.prePI_ind_u);
        vx=vconcat(sptensor(n_y,n_x,n_s),gx);
        vx=vconcat(vx,hx);
        vx=vconcat(vx,spteye(n_x,n_s));

    end
    if order>=2
        uname=['prePI' model.uname '_d3'];
        prePIzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        if ~isfield(model,'chain2c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,2);
            U2=create_UW(n_x,2);
            model.chain2c_theta_M2=spmat2sptensor(GAMMA.GAMMA1*U2);
            clear GAMMA U2
        end
        vxxc=vconcat(sptensor(n_y,unique2,n_s),gxxc);
        vxxc=vconcat(vxxc,hxxc);
        vxxc=vconcat(vxxc,sptensor(n_x,unique2,n_s));
    end
    if order>=3
        uname=['prePI' model.uname '_d4'];
        prePIzzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        if ~isfield(model,'x_chain3c_M2')
            [~,W2x]=create_UW(n_x,2);
            [U3x,~]=create_UW(n_x,3);
            OMEGAx=create_OMEGA(n_x,3);
            model.x_chain3c_M2=spmat2sptensor(kron(speye(n_x),W2x)*OMEGAx.OMEGA1*U3x);
            clear W2x U3x
        end
        if ~isfield(model,'chain3c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,3);
            [~,W2]=create_UW(n_x,2);
            U3=create_UW(n_x,3);
            model.chain3c_theta_M2=spmat2sptensor(kron(W2,speye(n_x))*GAMMA.GAMMA2*U3);
            model.chain3c_theta_M3=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA3*U3);
            model.chain3c_theta_M4=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA4*U3);
            tempind=1:unique2*n_x;
            tempmat=speye(unique2*n_x);
            model.chain3c_theta_M5=spmat2sptensor(tempmat(:,permute(reshape(tempind,n_x,unique2),[2,1]))*kron(speye(n_x),W2)*GAMMA.GAMMA5*U3);
            clear GAMMA W2 U3 GAMMA

        end
        vxxxc=vconcat(sptensor(n_y,unique3,n_s),gxxxc);
        vxxxc=vconcat(vxxxc,hxxxc);
        vxxxc=vconcat(vxxxc,sptensor(n_x,unique3,n_s));

    end
    if order>=4
        uname=['prePI' model.uname '_d5'];
        prePIzzzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        if ~isfield(model,'x_chain3c_M2')
            [~,W2x]=create_UW(n_x,2);
            [U3x,~]=create_UW(n_x,3);
            OMEGAx=create_OMEGA(n_x,3);
            model.x_chain3c_M2=spmat2sptensor(kron(speye(n_x),W2x)*OMEGAx.OMEGA1*U3x);
            clear W2x U3x
        end
        if ~isfield(model,'chain3c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,3);
            [~,W2]=create_UW(n_x,2);
            U3=create_UW(n_x,3);
            model.chain3c_theta_M2=spmat2sptensor(kron(W2,speye(n_x))*GAMMA.GAMMA2*U3);
            model.chain3c_theta_M3=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA3*U3);
            model.chain3c_theta_M4=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA4*U3);
            tempind=1:unique2*n_x;
            tempmat=speye(unique2*n_x);
            model.chain3c_theta_M5=spmat2sptensor(tempmat(:,permute(reshape(tempind,n_x,unique2),[2,1]))*kron(speye(n_x),W2)*GAMMA.GAMMA5*U3);
            clear GAMMA W2 U3 GAMMA

        end
        vxxxxc=vconcat(sptensor(n_y,unique4,n_s),gxxxxc);
        vxxxxc=vconcat(vxxxxc,hxxxxc);
        vxxxxc=vconcat(vxxxxc,sptensor(n_x,unique4,n_s));

    end
%     v_theta=[];
    v_theta=sptensor(0,(ms+1)*n_theta,n_s);
    if model.hybrid==3
        v_theta=vconcat(sptensor(n_y,(ms+1)*n_theta,n_s),v_theta_lower_terms);
        if order>=1
            vx_theta=vconcat(sptensor(n_y,[n_x,(ms+1)*n_theta],n_s),vx_theta_lower_terms);
        end
        if order>=2
            vxxc_theta=vconcat(sptensor(n_y,[unique2,(ms+1)*n_theta],n_s),vxxc_theta_lower_terms);
        end
        if order>=3
            vxxxc_theta=vconcat(sptensor(n_y,[unique3,(ms+1)*n_theta],n_s),vxxxc_theta_lower_terms);
        end
        if order>=4
            vxxxxc_theta=vconcat(sptensor(n_y,[unique4,(ms+1)*n_theta],n_s),vxxxxc_theta_lower_terms);
            if ~isfield(model,'x_chain4c_M2')
                [~,W2new]=create_UW(unique2,2);
                [~,W2x]=create_UW(n_x,2);
                [~,W3x]=create_UW(n_x,3);
                [U4x,~]=create_UW(n_x,4);
                OMEGAx=create_OMEGA(n_x,4);
                model.x_chain4c_M2=spmat2sptensor(kron(W2x,W2x)*OMEGAx.OMEGA2*U4x); 
                model.x_chain4c_M3=spmat2sptensor(kron(speye(n_x),W3x)*OMEGAx.OMEGA3*U4x);  
                model.x_chain4c_M4=spmat2sptensor(W2new*kron(W2x,W2x)*OMEGAx.OMEGA4*U4x); 
                clear W2new W2x W3x U4x OMEGAx
            end
            if ~isfield(model,'chain4c_theta_M2')
                GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,4);
                [~,W2]=create_UW(n_x,2);
                [~,W3]=create_UW(n_x,3);
                U4=create_UW(n_x,4);
                [~,W2new]=create_UW(unique2,2);
                model.chain4c_theta_M2=spmat2sptensor(kron(W3,speye(n_x))*GAMMA.GAMMA16*U4);
                model.chain4c_theta_M3=spmat2sptensor(kron(W2,W2)*GAMMA.GAMMA2*U4);
                model.chain4c_theta_M5=spmat2sptensor(kron(speye(n_x^2),W2)*GAMMA.GAMMA17*GAMMA.GAMMA2*U4);
                model.chain4c_theta_M6=spmat2sptensor(kron(speye(n_x),W3)*GAMMA.GAMMA3*U4);
                model.chain4c_theta_M9=spmat2sptensor(W2new*kron(W2,W2)*GAMMA.GAMMA4*U4);
                model.chain4c_theta_M10=spmat2sptensor(kron(W2,W2)*GAMMA.GAMMA18*GAMMA.GAMMA4*U4);

                clear GAMMA W2 W3 U4 W2new

            end
        end
    end
    
    totindi=5+8;
    totindi=totindi+model.count_pre_n*(1+3+4+6)+1+4+6+9;
    totindi=totindi+3;
    totindi=totindi+4;

    indi=totindi;
else

    fname=['pretilf' model.fname '_fun'];
    pref=feval(fname,nz(:,model.pretilfzvars),params); % since i already have z, i use pretilf to evaluate f.


    % compute derivatives of prePI and pretilf w.r.t z (prePI=nonstochastic rows of PI, pretilf=nonstochastic rows of f)
    uname=['prePI' model.uname '_d1'];
    prePIz_full=feval(uname,nz,params,model.prePI_ind_u);

    fname=['pretilf' model.fname '_tilf_d1'];
    pretilfz=feval(fname,[nv(:,prefvars),nu(:,model.prefuvars)],params,model.pretilf_ind_u);
    if order>=1
        uname=['prePI' model.uname '_d2'];
        prePIzz_full=feval(uname,nz,params,model.prePI_ind_u);
        fname=['pretilf' model.fname '_tilf_d2'];
        pretilfzz=feval(fname,[nv(:,prefvars),nu(:,model.prefuvars)],params,model.pretilf_ind_u);
    end
    if order>=2
        uname=['prePI' model.uname '_d3'];
        prePIzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        fname=['pretilf' model.fname '_tilf_d3'];
        pretilfzzz=feval(fname,[nv(:,prefvars),nu(:,model.prefuvars)],params,model.pretilf_ind_u);
    end
    if order>=3
        uname=['prePI' model.uname '_d4'];
        prePIzzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        fname=['pretilf' model.fname '_tilf_d4'];
        pretilfzzzz=feval(fname,[nv(:,prefvars),nu(:,model.prefuvars)],params,model.pretilf_ind_u);
    end
    if order>=4
        uname=['prePI' model.uname '_d5'];
        prePIzzzzz_full=feval(uname,nz,params,model.prePI_ind_u);
        fname=['pretilf' model.fname '_tilf_d5'];
        pretilfzzzzz=feval(fname,[nv(:,prefvars),nu(:,model.prefuvars)],params,model.pretilf_ind_u);
    end

    % extract derivatives of prePI w.r.t v from prePIz, prePIzz, ...
    if order>=0
        [prePIz,model.ind{indi}]=extract(prePIz_full,model.prefzvars,model.prefzvars,0,model.ind{indi});
        indi=indi+1;
        [prePIv,model.ind{indi}]=extract(prePIz_full,model.prefzvars,model.prefvars,0,model.ind{indi});
        indi=indi+1;
    end
    if order>=1
        [prePIzz,model.ind{indi}]=extract(prePIzz_full,model.prefzvars,model.prefzvars,0,model.ind{indi});
        indi=indi+1;
        [prePIvvc,model.ind{indi}]=extract(prePIzz_full,model.prefzvars,model.prefvars,1,model.ind{indi});
        indi=indi+1;
    end
    if order>=2
        [prePIzzz,model.ind{indi}]=extract(prePIzzz_full,model.prefzvars,model.prefzvars,0,model.ind{indi});
        indi=indi+1;
        [prePIvvvc,model.ind{indi}]=extract(prePIzzz_full,model.prefzvars,model.prefvars,1,model.ind{indi});
        indi=indi+1;
        if ~isfield(model,'prefvars_chain3c_M2')
            [ tempM ] = chainsM( n_prefvars,3 );
            model.prefvars_chain3c_M2=tempM{2};
            clear tempM
        end
    end
    if order>=3
        [prePIzzzz,model.ind{indi}]=extract(prePIzzzz_full,model.prefzvars,model.prefzvars,0,model.ind{indi});
        indi=indi+1;
        [prePIvvvvc,model.ind{indi}]=extract(prePIzzzz_full,model.prefzvars,model.prefvars,1,model.ind{indi});
        indi=indi+1;
        if ~isfield(model,'prefvars_chain4c_M2')
            [ tempM ] = chainsM( n_prefvars,4 );
            model.prefvars_chain4c_M2=tempM{2};
            model.prefvars_chain4c_M3=tempM{3};
            model.prefvars_chain4c_M4=tempM{4};
            clear tempM
        end
    end
    if order>=4
        [prePIzzzzz,model.ind4{indi4}]=extract(prePIzzzzz_full,model.prefzvars,model.prefzvars,0,model.ind4{indi4});
        indi4=indi4+1;
        [prePIvvvvvc,model.ind4{indi4}]=extract(prePIzzzzz_full,model.prefzvars,model.prefvars,1,model.ind4{indi4});
        indi4=indi4+1;
    end

    % Use high order chain rules to compute derivatives of prePI w.r.t v
    totindi=5+8;
    if order==0
        indi=totindi;
        for i=2:model.pre_n
            [prePIv,model.ind{indi}]=chain1_tensor(prePIz,prePIv,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [prefv,model.ind{indi}]=chain1_tensor(pretilfz,prePIv,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        model.prefv=prefv;
    elseif order==1
        indi=totindi+model.count_pre_n*(1)+1;
        for i=2:model.pre_n
            [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=chain2c_tensor(prePIz,prePIzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIv,model.ind{indi}]=chain1_tensor(prePIz,prePIv,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
        indi=indi+1;

        [prefv,model.ind{indi}]=chain1_tensor(pretilfz,prePIv,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvc,model.ind{indi}]=chain2c_tensor(pretilfz,pretilfzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [ prefvv,model.ind{indi} ] = uncompressderivs( prefvvc,2,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;
        
        model.prefv=prefv;
        model.prefvv=prefvv;

    elseif order==2
        indi=totindi+model.count_pre_n*(1+3)+1+4;
        for i=2:model.pre_n
%             tic
            [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
            indi=indi+1;
            [prePIvvvc,model.ind{indi}]=chain3c_tensor(prePIz,prePIzz,prePIzzz,...
                prePIv,prePIvvc,prePIvvvc,model.prefvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=chain2c_tensor(prePIz,prePIzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIv,model.ind{indi}]=chain1_tensor(prePIz,prePIv,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
%             toc
        end
        [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
        indi=indi+1;

        [prefv,model.ind{indi}]=chain1_tensor(pretilfz,prePIv,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvc,model.ind{indi}]=chain2c_tensor(pretilfz,pretilfzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvvc,model.ind{indi}]=chain3c_tensor(pretilfz,pretilfzz,pretilfzzz,...
            prePIv,prePIvvc,prePIvvvc,...
            model.prefvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [ prefvv,model.ind{indi} ] = uncompressderivs( prefvvc,2,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        [ prefvvv,model.ind{indi} ] = uncompressderivs( prefvvvc,3,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        model.prefv=prefv;
        model.prefvv=prefvv;
        model.prefvvv=prefvvv;
        
    elseif order==3
        indi=totindi+model.count_pre_n*(1+3+4)+1+4+6;
%     tic
        for i=2:model.pre_n
            [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=colsort(prePIvvc,model.ind{indi});
            indi=indi+1;
            [prePIvvvvc,model.ind{indi}]=chain4c_tensor(prePIz,prePIzz,prePIzzz,prePIzzzz,...
                prePIv,prePIvvc,prePIvvvc,prePIvvvvc,...
                model.prefvars_chain4c_M2,model.prefvars_chain4c_M3,model.prefvars_chain4c_M4,...
                model.ind{indi},n_ind,maxload,'vec',model.prezz,model.maxzz);
            indi=indi+1;
            [prePIvvvc,model.ind{indi}]=chain3c_tensor(prePIz,prePIzz,prePIzzz,...
                prePIv,prePIvvc,prePIvvvc,model.prefvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=chain2c_tensor(prePIz,prePIzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIv,model.ind{indi}]=chain1_tensor(prePIz,prePIv,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
% toc        
        [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
        indi=indi+1;
        [prePIvvc,model.ind{indi}]=colsort(prePIvvc,model.ind{indi});
        indi=indi+1;

        [prefv,model.ind{indi}]=chain1_tensor(pretilfz,prePIv,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [prefvvc,model.ind{indi}]=chain2c_tensor(pretilfz,pretilfzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvvc,model.ind{indi}]=chain3c_tensor(pretilfz,pretilfzz,pretilfzzz,...
            prePIv,prePIvvc,prePIvvvc,...
            model.prefvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvvvc,model.ind{indi}]=chain4c_tensor(pretilfz,pretilfzz,pretilfzzz,pretilfzzzz,...
            prePIv,prePIvvc,prePIvvvc,prePIvvvvc,...
            model.prefvars_chain4c_M2,model.prefvars_chain4c_M3,model.prefvars_chain4c_M4,...
            model.ind{indi},n_ind,maxload,'vec',model.pretilfz,model.maxtilfz);
        indi=indi+1;

        [ prefvv,model.ind{indi} ] = uncompressderivs( prefvvc,2,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        [ prefvvv,model.ind{indi} ] = uncompressderivs( prefvvvc,3,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        [ prefvvvv,model.ind{indi} ] = uncompressderivs( prefvvvvc,4,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        model.prefv=prefv;
        model.prefvv=prefvv;
        model.prefvvv=prefvvv;
        model.prefvvvv=prefvvvv;
    
    
    elseif order==4
        indi=totindi+model.count_pre_n*(1+3+4)+1+4+6;
        for i=2:model.pre_n
            [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=colsort(prePIvvc,model.ind{indi});
            indi=indi+1;
            [prePIvvvvvc,model.ind4{indi4}]=chain5c_tensor(prePIz,prePIzz,prePIzzz,prePIzzzz,prePIzzzzz,...
                prePIv,prePIvvc,prePIvvvc,prePIvvvvc,prePIvvvvvc,...
                model.prefvars_chain5c_M1,model.prefvars_chain5c_M2,model.prefvars_chain5c_M3,model.prefvars_chain5c_M4,model.prefvars_chain5c_M5,model.prefvars_chain5c_M6,...
                model.ind4{indi4},n_ind,maxload,'vec',model.prezz,model.maxzz);
            indi4=indi4+1;
            [prePIvvvvc,model.ind{indi}]=chain4c_tensor(prePIz,prePIzz,prePIzzz,prePIzzzz,...
                prePIv,prePIvvc,prePIvvvc,prePIvvvvc,...
                model.prefvars_chain4c_M2,model.prefvars_chain4c_M3,model.prefvars_chain4c_M4,...
                model.ind{indi},n_ind,maxload,'vec',model.prezz,model.maxzz);
            indi=indi+1;
            [prePIvvvc,model.ind{indi}]=chain3c_tensor(prePIz,prePIzz,prePIzzz,...
                prePIv,prePIvvc,prePIvvvc,model.prefvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIvvc,model.ind{indi}]=chain2c_tensor(prePIz,prePIzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [prePIv,model.ind{indi}]=chain1_tensor(prePIz,prePIv,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [prePIv,model.ind{indi}]=colsort(prePIv,model.ind{indi});
        indi=indi+1;
        [prePIvvc,model.ind{indi}]=colsort(prePIvvc,model.ind{indi});
        indi=indi+1;

        [prefv,model.ind{indi}]=chain1_tensor(pretilfz,prePIv,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [prefvvc,model.ind{indi}]=chain2c_tensor(pretilfz,pretilfzz,prePIv,prePIvvc,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvvc,model.ind{indi}]=chain3c_tensor(pretilfz,pretilfzz,pretilfzzz,...
            prePIv,prePIvvc,prePIvvvc,...
            model.prefvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [prefvvvvc,model.ind{indi}]=chain4c_tensor(pretilfz,pretilfzz,pretilfzzz,pretilfzzzz,...
            prePIv,prePIvvc,prePIvvvc,prePIvvvvc,...
            model.prefvars_chain4c_M2,model.prefvars_chain4c_M3,model.prefvars_chain4c_M4,...
            model.ind{indi},n_ind,maxload,'vec',model.pretilfz,model.maxtilfz);
        indi=indi+1;

        [prefvvvvvc,model.ind4{indi4}]=chain5c_tensor(pretilfz,pretilfzz,pretilfzzz,pretilfzzzz,pretilfzzzzz,...
            prePIv,prePIvvc,prePIvvvc,prePIvvvvc,prePIvvvvvc,...
            model.prefvars_chain5c_M1,model.prefvars_chain5c_M2,model.prefvars_chain5c_M3,model.prefvars_chain5c_M4,model.prefvars_chain5c_M5,model.prefvars_chain5c_M6,...
            model.ind4{indi4},n_ind,maxload,'vec',model.pretilfz,model.maxtilfz);
        indi4=indi4+1;
        
        [ prefvv,model.ind{indi} ] = uncompressderivs( prefvvc,2,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        [ prefvvv,model.ind{indi} ] = uncompressderivs( prefvvvc,3,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;

        [ prefvvvv,model.ind{indi} ] = uncompressderivs( prefvvvvc,4,n_prefvars,model.fv(model.prefrows,prefvars),model.ind{indi} );
        indi=indi+1;        

        [ prefvvvvv,model.ind4{indi4} ] = uncompressderivs( prefvvvvvc,5,n_prefvars,model.fv(model.prefrows,prefvars),model.ind4{indi4} );
        indi4=indi4+1;        
        
        model.prefv=prefv;
        model.prefvv=prefvv;
        model.prefvvv=prefvvv;
        model.prefvvvv=prefvvvv;
        
    end
    totindi=totindi+model.count_pre_n*(1+3+4+6)+1+4+6+9;
    indi=totindi;
    
    if model.steady_state==1
        if size(prefv.vals,1)~=1
            error('cannot compute steady state on vectorized tensors')
        end
        nzprefv=prefv;
        nzprefv.vals(:)=1;
        nzprefv=sptensor2spmat(nzprefv);
        nzprefv_full=zeros(n_prefrows,model.n_v);
        nzprefv_full(:,model.prefvars)=full(nzprefv);
        nzprefv_full(:,2*model.n_y+(1:model.n_x1))=nzprefv_full(:,2*model.n_y+(1:model.n_x1))+nzprefv_full(:,2*model.n_y+model.n_x+(1:model.n_x1));
        nzprefv=nzprefv_full(:,model.prefvars);
        [i,j]=find(nzprefv);
        
        prefv=sptensor2spmat(prefv);
        prefv_full=zeros(n_prefrows,model.n_v);
        prefv_full(:,model.prefvars)=full(prefv);
        prefv_full(:,2*model.n_y+(1:model.n_x1))=prefv_full(:,2*model.n_y+(1:model.n_x1))+prefv_full(:,2*model.n_y+model.n_x+(1:model.n_x1));
        prefv=prefv_full(:,model.prefvars);
        
        vals=prefv(logical(nzprefv(:)));
        
        prefv=sptensor(i(:),j(:),vals(:)',size(prefv,1),size(prefv,2));
    end

    tempT=sptensor(zeros(n_prefrows,1));
    tempT.vals=full(pref); % n_s,n_prefrows
    preR0=tempT;

    % compute R1 (first order derivatives of R w.r.t x)
    if order>=1
        if model.pde==0
            vx=vconcat(sptensor(n_y,n_x,n_s),gx);
        elseif model.pde==1
            vx=vconcat(sptensor(n_y*(n_x+1),n_x,n_s),gx_x);
            vx=vconcat(vx,gx);
        elseif model.pde>=2
            gx_x_gx=contraction1(AmatT,vconcat(gx_x,gx));
            vx=vconcat(sptensor(model.n_y_extended,n_x,n_s),gx_x_gx);
        end
        vx=vconcat(vx,hx);
        vx=vconcat(vx,spteye(n_x,n_s));
        model.vx=vx;

        prevx=takerows(vx,prefvars);
        if isempty(pref)
            preR1=sptensor(0,n_x,n_s);
        else
            [preR1,model.ind{indi}]=chain1_tensor(prefv,prevx,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
    end

    % compute R2 (second order derivatives of R w.r.t x)
    if order>=2
        if model.pde==0
            vxxc=vconcat(sptensor(n_y,unique2,n_s),gxxc);
        elseif model.pde==1
            vxxc=vconcat(sptensor(n_y*(n_x+1),unique2,n_s),gx_xxc);
            vxxc=vconcat(vxxc,gxxc);
        elseif model.pde>=2
            gx_xxc_gxxc=contraction1(AmatT,vconcat(gx_xxc,gxxc));
            vxxc=vconcat(sptensor(model.n_y_extended,unique2,n_s),gx_xxc_gxxc);
        end
        vxxc=vconcat(vxxc,hxxc);
        vxxc=vconcat(vxxc,sptensor(n_x,unique2,n_s));
        model.vxxc=vxxc;
        prevxxc=takerows(vxxc,prefvars);
        [prevx,model.ind4{indi4}]=colsort(prevx,model.ind4{indi4}); % i use model.ind4 because i forgot to put it in model.ind
        indi4=indi4+1;
        if isempty(pref)
            preR2=sptensor(0,unique2,n_s);
        else
            [preR2,model.ind{indi}]=chain2c_tensor(prefv,prefvv,prevx,prevxxc,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
    end

    % compute R3 (third order derivatives of R w.r.t x)
    if order>=3
        if model.pde==0
            vxxxc=vconcat(sptensor(n_y,unique3,n_s),gxxxc);
        elseif model.pde==1
            vxxxc=vconcat(sptensor(n_y*(n_x+1),unique3,n_s),gx_xxxc);
            vxxxc=vconcat(vxxxc,gxxxc);
        elseif model.pde>=2
            gx_xxxc_gxxxc=contraction1(AmatT,vconcat(gx_xxxc,gxxxc));
            vxxxc=vconcat(sptensor(model.n_y_extended,unique3,n_s),gx_xxxc_gxxxc);
        end
        vxxxc=vconcat(vxxxc,hxxxc);
        vxxxc=vconcat(vxxxc,sptensor(n_x,unique3,n_s));
        model.vxxxc=vxxxc;
        prevxxxc=takerows(vxxxc,prefvars);

        if ~isfield(model,'x_chain3c_M2')
            [~,W2x]=create_UW(n_x,2);
            [U3x,~]=create_UW(n_x,3);
            OMEGAx=create_OMEGA(n_x,3);
            model.x_chain3c_M2=spmat2sptensor(kron(speye(n_x),W2x)*OMEGAx.OMEGA1*U3x);
            clear W2x U3x OMEGAx
        end

        if isempty(pref)
            preR3=sptensor(0,unique3,n_s);
        else
            [preR3,model.ind{indi}]=chain3c_tensor(prefv,prefvv,prefvvv,prevx,prevxxc,prevxxxc,model.x_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end

    end
    
    % compute R4 (fourth order derivatives of R w.r.t x)
    if order>=4
        if model.pde==0
            vxxxxc=vconcat(sptensor(n_y,unique4,n_s),gxxxxc);
        elseif model.pde==1
            vxxxxc=vconcat(sptensor(n_y*(n_x+1),unique4,n_s),gx_xxxxc);
            vxxxxc=vconcat(vxxxxc,gxxxxc);
        elseif model.pde>=2
            gx_xxxxc_gxxxxc=contraction1(AmatT,vconcat(gx_xxxxc,gxxxxc));
            vxxxxc=vconcat(sptensor(model.n_y_extended,unique4,n_s),gx_xxxxc_gxxxxc);
        end
        vxxxxc=vconcat(vxxxxc,hxxxxc);
        vxxxxc=vconcat(vxxxxc,sptensor(n_x,unique4,n_s));
        model.vxxxxc=vxxxxc;
        prevxxxxc=takerows(vxxxxc,prefvars);

        if ~isfield(model,'x_chain4c_M2')
            [~,W2new]=create_UW(unique2,2);
            [~,W2x]=create_UW(n_x,2);
            [~,W3x]=create_UW(n_x,3);
            [U4x,~]=create_UW(n_x,4);
            OMEGAx=create_OMEGA(n_x,4);
            model.x_chain4c_M2=spmat2sptensor(kron(W2x,W2x)*OMEGAx.OMEGA2*U4x); 
            model.x_chain4c_M3=spmat2sptensor(kron(speye(n_x),W3x)*OMEGAx.OMEGA3*U4x);  
            model.x_chain4c_M4=spmat2sptensor(W2new*kron(W2x,W2x)*OMEGAx.OMEGA4*U4x); 
            clear W2new W2x W3x U4x OMEGAx
        end

        if isempty(pref)
            preR4=sptensor(0,unique4,n_s);
        else
            [prevxxc,model.ind4{indi4}]=colsort(prevxxc,model.ind4{indi4});
            indi4=indi4+1;

            [preR4,model.ind4{indi4}]=chain4c_tensor(prefv,prefvv,prefvvv,prefvvvv,prevx,prevxxc,prevxxxc,prevxxxxc,...
                model.x_chain4c_M2,model.x_chain4c_M3,model.x_chain4c_M4,model.ind4{indi4},n_ind,maxload,'vec');
            indi4=indi4+1;
        end

    end    
    totindi=totindi+3;
    indi=totindi;
    % Jacobian of the nonstochastic equations and derivatives

    if model.pde==0
        v_theta=vconcat(sptensor(n_y,(ms+1)*n_theta,n_s),v_theta_lower_terms);
    elseif model.pde==1
        v_theta=vconcat(sptensor(n_y*(n_x+1),(ms+1)*n_theta,n_s),v_theta_lower_terms);
    elseif model.pde>=2
        v_theta=vconcat(sptensor(model.n_y_extended,(ms+1)*n_theta,n_s),v_theta_lower_terms);
    end

    prev_theta=takerows(v_theta,prefvars);

    [ preJ0,model.ind{indi} ] = chain0_theta_tensor( prefv,prev_theta,model.ind{indi},n_ind,maxload,'vec' );
    indi=indi+1;

    if order>=1
        if model.pde==0
            vx_theta=vconcat(sptensor(n_y,[n_x,(ms+1)*n_theta],n_s),vx_theta_lower_terms);
        elseif model.pde==1
            vx_theta=vconcat(sptensor(n_y*(n_x+1),[n_x,(ms+1)*n_theta],n_s),vx_theta_lower_terms);
        elseif model.pde>=2
            vx_theta=vconcat(sptensor(model.n_y_extended,[n_x,(ms+1)*n_theta],n_s),vx_theta_lower_terms);
        end
        model.vx_theta=vx_theta;
        prevx_theta=takerows(vx_theta,prefvars);
        prevx_theta=unfold(prevx_theta);
        if isempty(pref)
            preJ1=sptensor(zeros(0,1),zeros(0,2),zeros(n_s,0),0,[n_x,(ms+1)*n_theta]);
        else
            [ preJ1,model.ind{indi} ] = chain1_theta_tensor( prefv,prefvv,...
                prevx,prev_theta,prevx_theta,...
                model.ind{indi},n_ind,maxload,'vec' );
            indi=indi+1;
        end
    end
    if order>=2
        if model.pde==0
            vxxc_theta=vconcat(sptensor(n_y,[unique2,(ms+1)*n_theta],n_s),vxxc_theta_lower_terms);
        elseif model.pde==1
            vxxc_theta=vconcat(sptensor(n_y*(n_x+1),[unique2,(ms+1)*n_theta],n_s),vxxc_theta_lower_terms);
        elseif model.pde>=2
            vxxc_theta=vconcat(sptensor(model.n_y_extended,[unique2,(ms+1)*n_theta],n_s),vxxc_theta_lower_terms);
        end
        model.vxxc_theta=vxxc_theta;
        prevxxc_theta=takerows(vxxc_theta,prefvars);
        prevxxc_theta=unfold(prevxxc_theta);

        if ~isfield(model,'chain2c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,2);
            U2=create_UW(n_x,2);
            model.chain2c_theta_M2=spmat2sptensor(GAMMA.GAMMA1*U2);
            clear GAMMA U2
        end

        if isempty(pref)
            preJ2=sptensor(zeros(0,1),zeros(0,2),zeros(n_s,0),0,[unique2,(ms+1)*n_theta]);
        else
        [ preJ2,model.ind{indi} ] = chain2c_theta_tensor( prefv,prefvv,prefvvv,...
            prevx,prevxxc,...
            prev_theta,prevx_theta,prevxxc_theta,...
            model.chain2c_theta_M2,...
            model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        end
    end
    if order>=3
        if model.pde==0
            vxxxc_theta=vconcat(sptensor(n_y,[unique3,(ms+1)*n_theta],n_s),vxxxc_theta_lower_terms);
        elseif model.pde==1
            vxxxc_theta=vconcat(sptensor(n_y*(n_x+1),[unique3,(ms+1)*n_theta],n_s),vxxxc_theta_lower_terms);
        elseif model.pde>=2
            vxxxc_theta=vconcat(sptensor(model.n_y_extended,[unique3,(ms+1)*n_theta],n_s),vxxxc_theta_lower_terms);
        end
        model.vxxxc_theta=vxxxc_theta;
        prevxxxc_theta=takerows(vxxxc_theta,prefvars);
        prevxxxc_theta=unfold(prevxxxc_theta);

        if ~isfield(model,'chain3c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,3);
            [~,W2]=create_UW(n_x,2);
            U3=create_UW(n_x,3);
            model.chain3c_theta_M2=spmat2sptensor(kron(W2,speye(n_x))*GAMMA.GAMMA2*U3);
            model.chain3c_theta_M3=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA3*U3);
            model.chain3c_theta_M4=spmat2sptensor(kron(speye(n_x),W2)*GAMMA.GAMMA4*U3);
            tempind=1:unique2*n_x;
            tempmat=speye(unique2*n_x);
            model.chain3c_theta_M5=spmat2sptensor(tempmat(:,permute(reshape(tempind,n_x,unique2),[2,1]))*kron(speye(n_x),W2)*GAMMA.GAMMA5*U3);
            clear GAMMA W2 U3 

        end

        if isempty(pref)
            preJ3=sptensor(zeros(0,1),zeros(0,2),zeros(n_s,0),0,[unique3,(ms+1)*n_theta]);
        else
            [ preJ3,model.ind{indi} ] = chain3c_theta_tensor( prefv,prefvv,prefvvv,prefvvvv,...
                prevx,prevxxc,prevxxxc,...
                prev_theta,prevx_theta,prevxxc_theta,prevxxxc_theta,...
                model.chain3c_theta_M2,model.chain3c_theta_M3,model.chain3c_theta_M4,model.chain3c_theta_M5,...
                model.ind{indi},n_ind,maxload,'vec' );
            indi=indi+1;
        end
    end
    if order>=4
        if model.pde==0
            vxxxxc_theta=vconcat(sptensor(n_y,[unique4,(ms+1)*n_theta],n_s),vxxxxc_theta_lower_terms);
        elseif model.pde==1
            vxxxxc_theta=vconcat(sptensor(n_y*(n_x+1),[unique4,(ms+1)*n_theta],n_s),vxxxxc_theta_lower_terms);
        elseif model.pde>=2
            vxxxxc_theta=vconcat(sptensor(model.n_y_extended,[unique4,(ms+1)*n_theta],n_s),vxxxxc_theta_lower_terms);
        end
        model.vxxxxc_theta=vxxxxc_theta;
        prevxxxxc_theta=takerows(vxxxxc_theta,prefvars);
        prevxxxxc_theta=unfold(prevxxxxc_theta);

        if ~isfield(model,'chain4c_theta_M2')
            GAMMA=create_GAMMA(n_x,(ms+1)*n_theta,4);
            [~,W2]=create_UW(n_x,2);
            [~,W3]=create_UW(n_x,3);
            U4=create_UW(n_x,4);
            [~,W2new]=create_UW(unique2,2);
            model.chain4c_theta_M2=spmat2sptensor(kron(W3,speye(n_x))*GAMMA.GAMMA16*U4);
            model.chain4c_theta_M3=spmat2sptensor(kron(W2,W2)*GAMMA.GAMMA2*U4);
            model.chain4c_theta_M5=spmat2sptensor(kron(speye(n_x^2),W2)*GAMMA.GAMMA17*GAMMA.GAMMA2*U4);
            model.chain4c_theta_M6=spmat2sptensor(kron(speye(n_x),W3)*GAMMA.GAMMA3*U4);
            model.chain4c_theta_M9=spmat2sptensor(W2new*kron(W2,W2)*GAMMA.GAMMA4*U4);
            model.chain4c_theta_M10=spmat2sptensor(kron(W2,W2)*GAMMA.GAMMA18*GAMMA.GAMMA4*U4);

            clear GAMMA W2 W3 U4 W2new

        end

        if isempty(pref)
            preJ4=sptensor(zeros(0,1),zeros(0,2),zeros(n_s,0),0,[unique4,(ms+1)*n_theta]);
        else
            [ preJ4,model.ind4{indi4} ] = chain4c_theta_tensor( prefv,prefvv,prefvvv,prefvvvv,prefvvvvv,...
                prevx,prevxxc,prevxxxc,prevxxxxc,...
                prev_theta,prevx_theta,prevxxc_theta,prevxxxc_theta,prevxxxxc_theta,...
                model.chain4c_theta_M2,model.chain4c_theta_M3,model.chain4c_theta_M5,model.chain4c_theta_M6,model.chain4c_theta_M9,model.chain4c_theta_M10,...
                model.ind4{indi4},n_ind,maxload,'vec' );
            indi4=indi4+1;
        end
    end    
    totindi=totindi+4;
    indi=totindi;
end

% STEP 2: COMPUTE STOCHASTIC EQUATIONS AND DERIVATIVES, AND THEIR JACOBIAN,
% AND TAKE EXPECTED VALUE

% prepare vectorized expressions for the stochastic part. 
if isempty(model.stochfrows)
    EstochR0=sptensor(0,1,n_s);
    EstochR1=sptensor(0,n_x,n_s);
    EstochR2=sptensor(0,unique2,n_s);
    EstochR3=sptensor(0,unique3,n_s);
    EstochR4=sptensor(0,unique4,n_s);
    EstochJ0=sptensor(0,(ms+1)*n_theta,n_s);
    EstochJ1=sptensor(0,[n_x,(ms+1)*n_theta],n_s);
    EstochJ2=sptensor(0,[unique2,(ms+1)*n_theta],n_s);
    EstochJ3=sptensor(0,[unique3,(ms+1)*n_theta],n_s);
    EstochJ4=sptensor(0,[unique4,(ms+1)*n_theta],n_s);
else
    nx_vec=repmat(nx(:)',n_nodes,1); % n_nodes=the number of nodes of the discrete shocks.
    nx_vec=reshape(nx_vec,n_nodes*n_s,[]);

    % next period state
    if model.hybrid==0
        nxp_vec=repmat(h(:),1,n_nodes)+reshape(etavec,[],n_e)*nep; %n_s*n_x,n_nodes
    elseif model.hybrid==1
        h_vec=repmat(h(:),1,n_nodes); %n_s*n_x,n_nodes
        
        params_vec=[repmat(nep',n_s,1),reshape(repmat(reshape(params(:,n_e+1:end),1,[]),n_nodes,1),n_nodes*n_s,[])]; %n_nodes*n_s,n_params
        uname=['Phi' model.uname '_fun'];
        tempvars=[nx,ny,nu(:,model.preurows)]; %n_s,n_x+n_y
        tempvars=reshape(repmat(tempvars(:)',n_nodes,1),n_nodes*n_s,[]); %n_s*n_nodes,n_x+n_y+n_preurows
        Phi_vec=feval(uname,tempvars,params_vec); %n_s*n_nodes,n_x2
        Phi_vec=permute(reshape(Phi_vec,n_s,n_nodes,n_x2),[1,3,2]); %n_s,n_x2,n_nodes
        h_vec=reshape(h_vec,n_s,n_x,n_nodes);
        h_vec(:,n_x1+1:end,:)=Phi_vec; 
        h_vec=reshape(h_vec,n_s*n_x,n_nodes);
        nxp_vec=h_vec+reshape(etavec,[],n_e)*nep; %n_s*n_x,n_nodes
    elseif model.hybrid==3
        h_vec=repmat(h(:),1,n_nodes); %n_s*n_x,n_nodes
        
        params_vec=[repmat(nep',n_s,1),reshape(repmat(reshape(params(:,n_e+1:end),1,[]),n_nodes,1),n_nodes*n_s,[])]; %n_nodes*n_s,n_params
        uname=['Phi' model.uname '_fun'];
        tempvars=nz(:,model.Phizvars); %n_s,n_x+n_y
        tempvars=reshape(repmat(tempvars(:)',n_nodes,1),n_nodes*n_s,[]); %n_nodes*n_s,n_x+n_y+n_preurows
        Phi_vec=feval(uname,tempvars,params_vec); %n_nodes*n_s,n_x2
        Phi_vec=permute(reshape(Phi_vec,n_nodes,n_s,n_x2),[2,3,1]); %n_s,n_x2,n_nodes
        h_vec=reshape(h_vec,n_s,n_x,n_nodes);
        h_vec(:,n_x1+1:end,:)=Phi_vec; 
        h_vec=reshape(h_vec,n_s*n_x,n_nodes);
        nxp_vec=h_vec+reshape(etavec,[],n_e)*nep; %n_s*n_x,n_nodes
    end
    
    nxp_c0_vec=nxp_vec-reshape(repmat(c0vec,1,n_nodes),n_s*n_x,n_nodes);

    nxp_vec_permuted=reshape(permute(reshape(nxp_vec,n_s,n_x,n_nodes),[3,1,2]),n_nodes*n_s,n_x);

    tempxp=1:n_x;
    tempxp=tempxp(:);
    nxp_c0=sptensor(tempxp); % convert to 1D tensor
    tempvals=reshape(nxp_c0_vec,n_s,n_x,n_nodes);
    tempvals=permute(tempvals,[3,1,2]);
    tempvals=reshape(tempvals,n_nodes*n_s,n_x);
    nxp_c0.vals=tempvals; % assign the correct values in vals.

    if ~isfield(model,'M2')
        model.M2=[];
        model.M3=[];
        model.M3x=[];
        model.TW2=[];
        model.TW3=[];
        model.M4=[];
        model.M4x=[];
        model.M4xx=[];
        model.M4xxx=[];
        if order>=2
            model.M2=fold(spmat2sptensor(model.W{2}*model.W{2}'*model.U{2}'),n_x,n_x);
            model.TW2=fold(spmat2sptensor(model.W{2}),n_x,n_x);
            model.TW2U2=spmat2sptensor(model.W{2}*model.U{2});
        end
        if order>=3
            model.M3=fold(spmat2sptensor(model.W{3}*model.W{3}'*model.U{3}'),n_x,n_x,n_x);
            model.M3x=fold(spmat2sptensor(3*model.W{3}*kron(model.W{2}'*model.U{2}',speye(n_x))),n_x,n_x,n_x);
            model.TW3=fold(spmat2sptensor(model.W{3}),n_x,n_x,n_x);
            model.TW3U3=spmat2sptensor(model.W{3}*model.U{3});
        end
        if order>=4
            model.M4=fold(spmat2sptensor(model.W{4}*model.W{4}'*model.U{4}'),n_x,n_x,n_x,n_x);
            model.M4x=fold(spmat2sptensor(4*model.W{4}*kron(model.W{3}'*model.U{3}',speye(n_x))),n_x,n_x,n_x,n_x);
            model.M4xx=fold(spmat2sptensor(12*model.W{4}*kron(model.W{2}'*model.U{2}',speye(n_x^2))),n_x,n_x,n_x,n_x);
            model.M4xxx=fold(spmat2sptensor(24*model.W{4}),n_x,n_x,n_x,n_x);
        end
    end

    [Xp_vecT,Xpx_vecT,Xpxx_vecT,Xpxxx_vecT,Xpxxxx_vecT,Xpxxxxx_vecT,model.ind{indi}]=create_X_tensor(order,nxp_c0,...
        model.M2,model.M3,model.M3x,model.TW2,model.TW3,model.M4,model.M4x,model.M4xx,model.M4xxx,unique2,unique3,unique4,model.ind{indi},n_ind,maxload,'vec');
    indi=indi+1;

    if strcmp(model.jacobian,'approximate')
          nx_c0=sptensor(n_x,1);
          nx_c0.vals=repmat(nx_c0.vals,n_nodes*n_s,1);
          [X_vecT,Xx_vecT,Xxx_vecT,Xxxx_vecT,Xxxxx_vecT,Xxxxxx_vecT,model.ind{indi}]=create_X_tensor(order,nx_c0,...
                model.M2,model.M3,model.M3x,model.TW2,model.TW3,model.M4,model.M4x,model.M4xx,model.M4xxx,unique2,unique3,unique4,model.ind{indi},n_ind,maxload,'vec');
          indi=indi+1;
    end
    totindi=totindi+2;
    indi=totindi;


    stochg_coeffsT=sptensor(ones(n_stochy,n_b)); 
    tempvals=stochg_coeffs; %n_s,n_stochy,n_b
    tempvals=permute(tempvals,[1,3,2]); % n_s,n_b,n_stochy
    tempvals=repmat(tempvals(:)',n_nodes,1); % n_nodes,n_s*n_b*n_stochy
    tempvals=reshape(tempvals,n_nodes*n_s,n_b*n_stochy);
    stochg_coeffsT.vals=tempvals;

    if model.n_logicalparams==0
        [stochgp_vecT,model.ind{indi}]=contraction1(stochg_coeffsT,Xp_vecT,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        gp_vec=changerows(stochgp_vecT,stochy,n_y);
        temp=zeros(n_nodes*n_s,n_y);
        temp(:,stochy)=gp_vec.vals;
    else
        g_coeffsT=sptensor(ones(n_y,n_b)); 
        g_coeffs=coeffspvec(:,1:n_y,:); 

        tempvals=g_coeffs; %n_s,n_y,n_b
        tempvals=permute(tempvals,[1,3,2]); % n_s,n_b,n_y
        tempvals=repmat(tempvals(:)',n_nodes,1); % n_nodes,n_s*n_b*n_y
        tempvals=reshape(tempvals,n_nodes*n_s,n_b*n_y);
        g_coeffsT.vals=tempvals;
        
        [gp_vecT,model.ind{indi}]=contraction1(g_coeffsT,Xp_vecT,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        gp_vec=changerows(gp_vecT,1:n_y,n_y);
        temp=zeros(n_nodes*n_s,n_y);
        temp(:,1:n_y)=gp_vec.vals;
        
    end
    gp_vec=temp; % n_nodes*n_s,n_y

    [stochgpx_vecT,model.ind{indi}]=contraction1(stochg_coeffsT,Xpx_vecT,model.ind{indi},n_ind,maxload,'vec');
    indi=indi+1;

    % control vars in t+1
    nyp_vec=gp_vec;

    % evaluate residuals R0
    nv_vec=[nyp_vec,reshape(repmat(ny(:)',n_nodes,1),n_nodes*n_s,[]),nxp_vec_permuted,nx_vec];
    % nstochv_vec=nv_vec(:,stochfvars); % stochastic vars.

    if model.hybrid==0
        params_vec=reshape(repmat(params(:)',n_nodes,1),n_nodes*n_s,n_params);
    end
    
    uname=['stochu' model.uname '_fun'];
    nstochu_vec=feval(uname,nv_vec(:,model.stochuvars),params_vec); % all stochastic u vars
    nu_vec=reshape(repmat(nu(:)',n_nodes,1),n_nodes*n_s,[]);

    nu_vec(:,model.stochurows)=nstochu_vec;
    nz_vec=[nv_vec,nu_vec];
    params_vec(:,model.logical_params_loc)=double(logical(nz_vec(:,model.logical_zvars)>0));

    fname=['stochtilf' model.fname '_fun'];
    stochf_vec=feval(fname,nz_vec(:,model.stochtilfzvars),params_vec);

    % compute derivatives of stochPI and stochtilf w.r.t z
    uname=['stochPI' model.uname '_d1'];
    stochPIz_vec=feval(uname,nz_vec,params_vec,model.stochPI_ind_u);
    prePIz_full.vals=reshape(repmat(prePIz_full.vals(:)',n_nodes,1),n_nodes*n_s,[]);

    i1=tfind(prePIz_full);
    i2=tfind(stochPIz_vec);
    PIz_vec=sptensor([i1;i2],[prePIz_full.cols;stochPIz_vec.cols],[prePIz_full.vals,stochPIz_vec.vals],n_z,[n_z]);

    fname=['stochtilf' model.fname '_tilf_d1'];
    stochtilfz_vec=feval(fname,[nv_vec(:,stochfvars),nu_vec(:,model.stochfuvars)],params_vec,model.stochtilf_ind_u);


    if order>=1
        uname=['stochPI' model.uname '_d2'];
        stochPIzz_vec=feval(uname,nz_vec,params_vec,model.stochPI_ind_u);
        prePIzz_full.vals=reshape(repmat(prePIzz_full.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        i1=tfind(prePIzz_full);
        i2=tfind(stochPIzz_vec);
        PIzz_vec=sptensor([i1;i2],[prePIzz_full.cols;stochPIzz_vec.cols],[prePIzz_full.vals,stochPIzz_vec.vals],n_z,[n_z,n_z]);

        fname=['stochtilf' model.fname '_tilf_d2'];
        stochtilfzz_vec=feval(fname,[nv_vec(:,stochfvars),nu_vec(:,model.stochfuvars)],params_vec,model.stochtilf_ind_u);
    end
    if order>=2
        uname=['stochPI' model.uname '_d3'];
        stochPIzzz_vec=feval(uname,nz_vec,params_vec,model.stochPI_ind_u);
        prePIzzz_full.vals=reshape(repmat(prePIzzz_full.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        i1=tfind(prePIzzz_full);
        i2=tfind(stochPIzzz_vec);
        PIzzz_vec=sptensor([i1;i2],[prePIzzz_full.cols;stochPIzzz_vec.cols],[prePIzzz_full.vals,stochPIzzz_vec.vals],n_z,[n_z,n_z,n_z]);
        fname=['stochtilf' model.fname '_tilf_d3'];
        stochtilfzzz_vec=feval(fname,[nv_vec(:,stochfvars),nu_vec(:,model.stochfuvars)],params_vec,model.stochtilf_ind_u);
    end
    if order>=3
        uname=['stochPI' model.uname '_d4'];
        stochPIzzzz_vec=feval(uname,nz_vec,params_vec,model.stochPI_ind_u);
        prePIzzzz_full.vals=reshape(repmat(prePIzzzz_full.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        i1=tfind(prePIzzzz_full);
        i2=tfind(stochPIzzzz_vec);
        PIzzzz_vec=sptensor([i1;i2],[prePIzzzz_full.cols;stochPIzzzz_vec.cols],[prePIzzzz_full.vals,stochPIzzzz_vec.vals],n_z,[n_z,n_z,n_z,n_z]);
        fname=['stochtilf' model.fname '_tilf_d4'];
        stochtilfzzzz_vec=feval(fname,[nv_vec(:,stochfvars),nu_vec(:,model.stochfuvars)],params_vec,model.stochtilf_ind_u);
    end
    if order>=4
        uname=['stochPI' model.uname '_d5'];
        stochPIzzzzz_vec=feval(uname,nz_vec,params_vec,model.stochPI_ind_u);
        prePIzzzzz_full.vals=reshape(repmat(prePIzzzzz_full.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        i1=tfind(prePIzzzzz_full);
        i2=tfind(stochPIzzzzz_vec);
        PIzzzzz_vec=sptensor([i1;i2],[prePIzzzzz_full.cols;stochPIzzzzz_vec.cols],[prePIzzzzz_full.vals,stochPIzzzzz_vec.vals],n_z,[n_z,n_z,n_z,n_z,n_z]);
        fname=['stochtilf' model.fname '_tilf_d5'];
        stochtilfzzzzz_vec=feval(fname,[nv_vec(:,stochfvars),nu_vec(:,model.stochfuvars)],params_vec,model.stochtilf_ind_u);
    end

    totindi=totindi+2;
    indi=totindi;

    % stochf_vec is n_nodes*n_s,n_stochf
    EstochR0=P'*reshape(stochf_vec,n_nodes,[]); %expected value of stochR0
    EstochR0=reshape(EstochR0,n_s,[]);

    tempT=sptensor(zeros(n_stochfrows,1));
    tempT.vals=full(EstochR0);
    EstochR0=tempT;

    % compute derivatives of Phi w.r.t x and theta for a model with hybrid
    % state variables
    if model.hybrid==1 || model.hybrid==3
        get_hybridPhi_derivs_v;
        get_hybridPhi_derivs_x_theta;
        
    end
    
    
    h_thetaT=h_theta;
    h_thetaT.vals=reshape(repmat(h_thetaT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
    
    if model.hybrid==1 || model.hybrid==3 % add Phitheta
        h_thetaT=vconcat(takerows(h_thetaT,1:n_x1),Phitheta);
    end
    
    [chain0_theta_stochgpT,model.ind{indi}]=contraction1(stochgpx_vecT,h_thetaT,model.ind{indi},n_ind,maxload,'vec');
    indi=indi+1;

    totindi=totindi+1;
    indi=totindi;

    % compute derivatives of g w.r.t x at next period state (nxp)
    if order>=1
        if order>1
            [stochgpxx_vecT,model.ind{indi}]=contraction1(stochg_coeffsT,Xpxx_vecT,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        else
            stochgpxx_vecT=sptensor(n_stochy,n_x^2,n_nodes);
        end
        hxT=hx;
        hxT.vals=reshape(repmat(hxT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phix
            hxT=vconcat(takerows(hxT,1:n_x1),Phix);
        end
        
        [chain1_stochgpT,model.ind{indi}]=contraction1(stochgpx_vecT,hxT,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        hx_thetaT=unfold(hx_theta);
        hx_thetaT.vals=reshape(repmat(hx_thetaT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixtheta
            hx_thetaT=vconcat(takerows(hx_thetaT,1:n_x1),unfold(Phixtheta));
        end

        
        stochgpxx_vecT=fold(stochgpxx_vecT,n_x,n_x);
        [chain1_theta_stochgpT,model.ind{indi}]=chain1_theta_tensor(stochgpx_vecT,stochgpxx_vecT,hxT,h_thetaT,hx_thetaT,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
    end
    if order>=2
        if order>2
            [stochgpxxx_vecT,model.ind{indi}]=contraction1(stochg_coeffsT,Xpxxx_vecT,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        else
            stochgpxxx_vecT=sptensor(n_stochy,n_x^3,n_nodes);
        end
        hxxcT=hxxc;
        hxxcT.vals=reshape(repmat(hxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxc
            hxxcT=vconcat(takerows(hxxcT,1:n_x1),Phixxc);
        end
        
        [hxT,model.ind4{indi4}]=colsort(hxT,model.ind4{indi4});
        indi4=indi4+1;
        [chain2_stochgpT,model.ind{indi}]=chain2c_tensor(stochgpx_vecT,stochgpxx_vecT,hxT,hxxcT,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        hxxc_thetaT=unfold(hxxc_theta);
        hxxc_thetaT.vals=reshape(repmat(hxxc_thetaT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxctheta
            hxxc_thetaT=vconcat(takerows(hxxc_thetaT,1:n_x1),unfold(Phixxctheta));
        end
        
        stochgpxxx_vecT=fold(stochgpxxx_vecT,n_x,n_x,n_x);

        [chain2c_theta_stochgpT,model.ind{indi}]=chain2c_theta_tensor(stochgpx_vecT,stochgpxx_vecT,stochgpxxx_vecT,hxT,hxxcT,h_thetaT,hx_thetaT,hxxc_thetaT,...
            model.chain2c_theta_M2,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
    end
    if order>=3
        if order>3
            [stochgpxxxx_vecT,model.ind{indi}]=contraction1(stochg_coeffsT,Xpxxxx_vecT,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        else
            stochgpxxxx_vecT=sptensor(n_stochy,n_x^4,n_nodes);
        end
        hxxxcT=hxxxc;
        hxxxcT.vals=reshape(repmat(hxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxxc
            hxxxcT=vconcat(takerows(hxxxcT,1:n_x1),Phixxxc);
        end
        
        [chain3_stochgpT,model.ind{indi}]=chain3c_tensor(stochgpx_vecT,stochgpxx_vecT,stochgpxxx_vecT,...
            hxT,hxxcT,hxxxcT,...
            model.x_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        hxxxc_thetaT=unfold(hxxxc_theta);
        hxxxc_thetaT.vals=reshape(repmat(hxxxc_thetaT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxxctheta
            hxxxc_thetaT=vconcat(takerows(hxxxc_thetaT,1:n_x1),unfold(Phixxxctheta));
        end
        
        stochgpxxxx_vecT=fold(stochgpxxxx_vecT,n_x,n_x,n_x,n_x);

        [chain3c_theta_stochgpT,model.ind{indi}]=chain3c_theta_tensor(stochgpx_vecT,stochgpxx_vecT,stochgpxxx_vecT,stochgpxxxx_vecT,...
        hxT,hxxcT,hxxxcT,h_thetaT,hx_thetaT,hxxc_thetaT,hxxxc_thetaT,...
            model.chain3c_theta_M2,model.chain3c_theta_M3,model.chain3c_theta_M4,model.chain3c_theta_M5,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;   
    end
    if order>=4
        if order>4
            [stochgpxxxxx_vecT,model.ind4{indi4}]=contraction1(stochg_coeffsT,Xpxxxxx_vecT,model.ind4{indi4},n_ind,maxload,'vec');
            indi4=indi4+1;
        else
            stochgpxxxxx_vecT=sptensor(n_stochy,n_x^5,n_nodes);
        end
        hxxxxcT=hxxxxc;
        hxxxxcT.vals=reshape(repmat(hxxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxxxc
            hxxxxcT=vconcat(takerows(hxxxxcT,1:n_x1),Phixxxxc);
        end
       
        [hxxcT,model.ind4{indi4}]=colsort(hxxcT,model.ind4{indi4});
        indi4=indi4+1;
        
        [chain4_stochgpT,model.ind4{indi4}]=chain4c_tensor(stochgpx_vecT,stochgpxx_vecT,stochgpxxx_vecT,stochgpxxxx_vecT,...
            hxT,hxxcT,hxxxcT,hxxxxcT,...
            model.x_chain4c_M2,model.x_chain4c_M3,model.x_chain4c_M4,model.ind4{indi4},n_ind,maxload,'vec');
        indi4=indi4+1;

        hxxxxc_thetaT=unfold(hxxxxc_theta);
        hxxxxc_thetaT.vals=reshape(repmat(hxxxxc_thetaT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

        if model.hybrid==1 || model.hybrid==3 % add Phixxxxctheta
            hxxxxc_thetaT=vconcat(takerows(hxxxxc_thetaT,1:n_x1),unfold(Phixxxxctheta));
        end
        
        stochgpxxxxx_vecT=fold(stochgpxxxxx_vecT,n_x,n_x,n_x,n_x,n_x);

        [chain4c_theta_stochgpT,model.ind4{indi4}]=chain4c_theta_tensor(stochgpx_vecT,stochgpxx_vecT,stochgpxxx_vecT,stochgpxxxx_vecT,stochgpxxxxx_vecT,...
        hxT,hxxcT,hxxxcT,hxxxxcT,h_thetaT,hx_thetaT,hxxc_thetaT,hxxxc_thetaT,hxxxxc_thetaT,...
            model.chain4c_theta_M2,model.chain4c_theta_M3,model.chain4c_theta_M5,model.chain4c_theta_M6,model.chain4c_theta_M9,model.chain4c_theta_M10,...
            model.ind4{indi4},n_ind,maxload,'vec');
        indi4=indi4+1;   
    end    
    totindi=totindi+9;
    indi=totindi;

    % extract PIv,Pivv,... from PIz,PIzz,...
    if order>=0
        [stochPIz_vec,model.ind{indi}]=extract(PIz_vec,model.stochfzvars,model.stochfzvars,0,model.ind{indi});
        indi=indi+1;
        [stochPIv_vec,model.ind{indi}]=extract(PIz_vec,model.stochfzvars,model.stochfvars,0,model.ind{indi});
        indi=indi+1;  
    end
    if order>=1
        [stochPIzz_vec,model.ind{indi}]=extract(PIzz_vec,model.stochfzvars,model.stochfzvars,0,model.ind{indi});
        indi=indi+1;
        [stochPIvvc_vec,model.ind{indi}]=extract(PIzz_vec,model.stochfzvars,model.stochfvars,1,model.ind{indi});
        indi=indi+1;
    end
    if order>=2
        [stochPIzzz_vec,model.ind{indi}]=extract(PIzzz_vec,model.stochfzvars,model.stochfzvars,0,model.ind{indi});
        indi=indi+1;
        [stochPIvvvc_vec,model.ind{indi}]=extract(PIzzz_vec,model.stochfzvars,model.stochfvars,1,model.ind{indi});
        indi=indi+1;
        if ~isfield(model,'stochfvars_chain3c_M2')
            [ tempM ] = chainsM( n_stochfvars,3 );
            model.stochfvars_chain3c_M2=tempM{2};
            clear tempM
        end
    end
    if order>=3
        [stochPIzzzz_vec,model.ind{indi}]=extract(PIzzzz_vec,model.stochfzvars,model.stochfzvars,0,model.ind{indi});
        indi=indi+1;
        [stochPIvvvvc_vec,model.ind{indi}]=extract(PIzzzz_vec,model.stochfzvars,model.stochfvars,1,model.ind{indi});
        indi=indi+1;
        if ~isfield(model,'stochfvars_chain4c_M2')
            [ tempM ] = chainsM( n_stochfvars,4 );
            model.stochfvars_chain4c_M2=tempM{2};
            model.stochfvars_chain4c_M3=tempM{3};
            model.stochfvars_chain4c_M4=tempM{4};
            clear tempM
        end
    end
    if order>=4
        [stochPIzzzzz_vec,model.ind4{indi4}]=extract(PIzzzzz_vec,model.stochfzvars,model.stochfzvars,0,model.ind4{indi4});
        indi4=indi4+1;
        [stochPIvvvvvc_vec,model.ind4{indi4}]=extract(PIzzzzz_vec,model.stochfzvars,model.stochfvars,1,model.ind4{indi4});
        indi4=indi4+1;
    end
    totindi=totindi+8;
    indi=totindi;


    % compute derivatives of stochf w.r.t v by high order chain rules, and
    % multiply by the weights P (probabilities).
    Pvec=repmat(P(:),n_s,1);
    if order==0
        indi=totindi;
        for i=2:model.stoch_n
            [stochPIv_vec,model.ind{indi}]=chain1_tensor(stochPIz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [stochfv_vec,model.ind{indi}]=chain1_tensor(stochtilfz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        stochfv_vec.vals=multcol(stochfv_vec.vals,Pvec);
        
        model.stochfv_vec=stochfv_vec;
        
    elseif order==1
        indi=totindi+model.count_stoch_n*(1)+1;
        for i=2:model.stoch_n
            [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=chain2c_tensor(stochPIz_vec,stochPIzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIv_vec,model.ind{indi}]=chain1_tensor(stochPIz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
        indi=indi+1;

        [stochfv_vec,model.ind{indi}]=chain1_tensor(stochtilfz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvc_vec,model.ind{indi}]=chain2c_tensor(stochtilfz_vec,stochtilfzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        stochfv_vec.vals=multcol(stochfv_vec.vals,Pvec);
        stochfvvc_vec.vals=multcol(stochfvvc_vec.vals,Pvec);

        [ stochfvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvc_vec,2,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvc_vec

    elseif order==2
        indi=totindi+model.count_stoch_n*(1+3)+1+4;
        for i=2:model.stoch_n
            [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvvc_vec,model.ind{indi}]=chain3c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,model.stochfvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=chain2c_tensor(stochPIz_vec,stochPIzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIv_vec,model.ind{indi}]=chain1_tensor(stochPIz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
        indi=indi+1;

        [stochfv_vec,model.ind{indi}]=chain1_tensor(stochtilfz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvc_vec,model.ind{indi}]=chain2c_tensor(stochtilfz_vec,stochtilfzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvvc_vec,model.ind{indi}]=chain3c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,...
            model.stochfvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        stochfv_vec.vals=multcol(stochfv_vec.vals,Pvec);
        stochfvvc_vec.vals=multcol(stochfvvc_vec.vals,Pvec);
        stochfvvvc_vec.vals=multcol(stochfvvvc_vec.vals,Pvec);

        [ stochfvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvc_vec,2,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvc_vec

        [ stochfvvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvvc_vec,3,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvvc_vec

    elseif order==3
        indi=totindi+model.count_stoch_n*(1+3+4)+1+4+6;
        for i=2:model.stoch_n
            [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=colsort(stochPIvvc_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvvvc_vec,model.ind{indi}]=chain4c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,stochPIzzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,...
                model.stochfvars_chain4c_M2,model.stochfvars_chain4c_M3,model.stochfvars_chain4c_M4,...
                model.ind{indi},n_ind,maxload,'vec',model.stochzz,model.maxzz);
            indi=indi+1;
            [stochPIvvvc_vec,model.ind{indi}]=chain3c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,model.stochfvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=chain2c_tensor(stochPIz_vec,stochPIzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIv_vec,model.ind{indi}]=chain1_tensor(stochPIz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
        indi=indi+1;
        [stochPIvvc_vec,model.ind{indi}]=colsort(stochPIvvc_vec,model.ind{indi});
        indi=indi+1;

        [stochfv_vec,model.ind{indi}]=chain1_tensor(stochtilfz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [stochfvvc_vec,model.ind{indi}]=chain2c_tensor(stochtilfz_vec,stochtilfzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvvc_vec,model.ind{indi}]=chain3c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,...
            model.stochfvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvvvc_vec,model.ind{indi}]=chain4c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,stochtilfzzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,...
            model.stochfvars_chain4c_M2,model.stochfvars_chain4c_M3,model.stochfvars_chain4c_M4,...
            model.ind{indi},n_ind,maxload,'vec',model.stochtilfz,model.maxtilfz);
        indi=indi+1;

        stochfv_vec.vals=multcol(stochfv_vec.vals,Pvec);
        stochfvvc_vec.vals=multcol(stochfvvc_vec.vals,Pvec);
        stochfvvvc_vec.vals=multcol(stochfvvvc_vec.vals,Pvec);
        stochfvvvvc_vec.vals=multcol(stochfvvvvc_vec.vals,Pvec);

        [ stochfvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvc_vec,2,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvc_vec

        [ stochfvvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvvc_vec,3,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvvc_vec

        [ stochfvvvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvvvc_vec,4,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvvvc_vec
    elseif order==4
        indi=totindi+model.count_stoch_n*(1+3+4)+1+4+6;
        for i=2:model.stoch_n
            [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=colsort(stochPIvvc_vec,model.ind{indi});
            indi=indi+1;
            [stochPIvvvvvc_vec,model.ind4{indi4}]=chain5c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,stochPIzzzz_vec,stochPIzzzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,stochPIvvvvvc_vec,...
                model.stochfvars_chain5c_M1,model.stochfvars_chain5c_M2,model.stochfvars_chain5c_M3,model.stochfvars_chain5c_M4,model.stochfvars_chain5c_M5,model.stochfvars_chain5c_M6,...
                model.ind4{indi4},n_ind,maxload,'vec',model.stochzz,model.maxzz);
            indi4=indi4+1;
            [stochPIvvvvc_vec,model.ind{indi}]=chain4c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,stochPIzzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,...
                model.stochfvars_chain4c_M2,model.stochfvars_chain4c_M3,model.stochfvars_chain4c_M4,...
                model.ind{indi},n_ind,maxload,'vec',model.stochzz,model.maxzz);
            indi=indi+1;
            [stochPIvvvc_vec,model.ind{indi}]=chain3c_tensor(stochPIz_vec,stochPIzz_vec,stochPIzzz_vec,...
                stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,model.stochfvars_chain3c_M2,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIvvc_vec,model.ind{indi}]=chain2c_tensor(stochPIz_vec,stochPIzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
            [stochPIv_vec,model.ind{indi}]=chain1_tensor(stochPIz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
            indi=indi+1;
        end
        [stochPIv_vec,model.ind{indi}]=colsort(stochPIv_vec,model.ind{indi});
        indi=indi+1;
        [stochPIvvc_vec,model.ind{indi}]=colsort(stochPIvvc_vec,model.ind{indi});
        indi=indi+1;

        [stochfv_vec,model.ind{indi}]=chain1_tensor(stochtilfz_vec,stochPIv_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;

        [stochfvvc_vec,model.ind{indi}]=chain2c_tensor(stochtilfz_vec,stochtilfzz_vec,stochPIv_vec,stochPIvvc_vec,model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvvc_vec,model.ind{indi}]=chain3c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,...
            model.stochfvars_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec');
        indi=indi+1;
        [stochfvvvvc_vec,model.ind{indi}]=chain4c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,stochtilfzzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,...
            model.stochfvars_chain4c_M2,model.stochfvars_chain4c_M3,model.stochfvars_chain4c_M4,...
            model.ind{indi},n_ind,maxload,'vec',model.stochtilfz,model.maxtilfz);
        indi=indi+1;
        [stochfvvvvvc_vec,model.ind4{indi4}]=chain5c_tensor(stochtilfz_vec,stochtilfzz_vec,stochtilfzzz_vec,stochtilfzzzz_vec,stochtilfzzzzz_vec,...
            stochPIv_vec,stochPIvvc_vec,stochPIvvvc_vec,stochPIvvvvc_vec,stochPIvvvvvc_vec,...
            model.stochfvars_chain5c_M1,model.stochfvars_chain5c_M2,model.stochfvars_chain5c_M3,model.stochfvars_chain5c_M4,model.stochfvars_chain5c_M5,model.stochfvars_chain5c_M6,...
            model.ind4{indi4},n_ind,maxload,'vec',model.stochtilfz,model.maxtilfz);
        indi4=indi4+1;

        stochfv_vec.vals=multcol(stochfv_vec.vals,Pvec);
        stochfvvc_vec.vals=multcol(stochfvvc_vec.vals,Pvec);
        stochfvvvc_vec.vals=multcol(stochfvvvc_vec.vals,Pvec);
        stochfvvvvc_vec.vals=multcol(stochfvvvvc_vec.vals,Pvec);
        stochfvvvvvc_vec.vals=multcol(stochfvvvvvc_vec.vals,Pvec);

        [ stochfvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvc_vec,2,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvc_vec

        [ stochfvvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvvc_vec,3,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvvc_vec

        [ stochfvvvv_vec,model.ind{indi} ] = uncompressderivs( stochfvvvvc_vec,4,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind{indi} );
        indi=indi+1;
        clear stochfvvvvc_vec

        [ stochfvvvvv_vec,model.ind4{indi4} ] = uncompressderivs( stochfvvvvvc_vec,5,n_stochfvars,model.fv(model.stochfrows,stochfvars),model.ind4{indi4} );
        indi4=indi4+1;
        clear stochfvvvvvc_vec
        
    end
    totindi=totindi+8+model.count_stoch_n*(1+3+4+6)+1+4+6+9;
    indi=totindi;

    
    if model.steady_state==1
        if size(stochfv_vec.vals,1)~=1
            error('cannot compute steady state on vectorized tensors')
        end
        nzstochfv=stochfv_vec;
        nzstochfv.vals(:)=1;
        nzstochfv=sptensor2spmat(nzstochfv);
        nzstochfv_full=zeros(n_stochfrows,model.n_v);
        nzstochfv_full(:,model.stochfvars)=full(nzstochfv);
        nzstochfv_full(:,2*model.n_y+(1:model.n_x1))=nzstochfv_full(:,2*model.n_y+(1:model.n_x1))+nzstochfv_full(:,2*model.n_y+model.n_x+(1:model.n_x1));
        nzstochfv=nzstochfv_full(:,model.stochfvars);
        [i,j]=find(nzstochfv);
        
        stochfv=sptensor2spmat(stochfv_vec);
        stochfv_full=zeros(n_stochfrows,model.n_v);
        stochfv_full(:,model.stochfvars)=full(stochfv);
        stochfv_full(:,2*model.n_y+(1:model.n_x1))=stochfv_full(:,2*model.n_y+(1:model.n_x1))+stochfv_full(:,2*model.n_y+model.n_x+(1:model.n_x1));
        stochfv=stochfv_full(:,model.stochfvars);
        
        vals=stochfv(logical(nzstochfv(:)));
        
        stochfv_vec=sptensor(i(:),j(:),vals(:)',size(stochfv,1),size(stochfv,2));
    end
    
    
    temp=reshape((1:n_theta)+ms*n_theta,[],n_b);
    stochtheta=temp(stochy,:);
    stochtheta=stochtheta(:);
    n_stochtheta=length(stochtheta);

    % exact/approximate Jacobian of gp,gpx,... 
    IstochyT=spteye(n_stochy);
    if strcmp(model.jacobian,'exact')
          [stochgp_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xp_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
          indi=indi+1;
    else
          [stochgp_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(X_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
          indi=indi+1;
    end

    if ms==0
        nnzgp_theta_vecT=unfold(changecols(changerows(stochgp_stochtheta_vecT,stochy,n_y),stochy,n_y+n_x1,1)); %n_y,n_theta with only nnz values
    else
        
        nnzgp_theta_vecT=unfold(changecols(changerows(unfold(stochgp_stochtheta_vecT),stochy,n_y),stochtheta,(ms+1)*n_theta,1)); %n_y,n_theta with only nnz values
    end
    nnzchain0_theta_gpT=changerows(chain0_theta_stochgpT,stochy,n_y);

    v_theta_lower_terms_vecT=v_theta_lower_terms;
    v_theta_lower_terms_vecT.vals=reshape(repmat(v_theta_lower_terms_vecT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

    if model.hybrid==3 % not necessary for model.hybrid==1 because x2p does not appear in any of the equations
        temp=vconcat(takerows(v_theta_lower_terms_vecT,1:n_y+n_x1),Phitheta);
        temp=vconcat(temp,takerows(v_theta_lower_terms_vecT,n_y+n_x+(1:n_x)));
        v_theta_lower_terms_vecT=temp;
    end
    
    v_theta_vecT=vconcat(tplus(nnzchain0_theta_gpT,nnzgp_theta_vecT,maxload),v_theta_lower_terms_vecT);
    clear nnzchain0_theta_gpT nnzgp_theta_vecT
    stochv_theta_vecT=takerows(v_theta_vecT,stochfvars);

    clear v_theta_vecT

    totindi=totindi+2;
    indi=totindi;
    % derivatives of v w.r.t x
    if order>=1
          vxT=vx;
          if model.hybrid==0 || model.hybrid==1
              stochvxT=takerows(vxT,stochfvars(n_stochy+1:end));
              stochvxT.vals=reshape(repmat(stochvxT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
          elseif model.hybrid==3
              vxT.vals=reshape(repmat(vxT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
              temp=vconcat(takerows(vxT,1:2*n_y+n_x1),Phix);
              temp=vconcat(temp,takerows(vxT,2*n_y+n_x+(1:n_x)));
              vxT=temp;
              stochvxT=takerows(vxT,stochfvars(n_stochy+1:end));
          end
          stochvxT=vconcat(chain1_stochgpT,stochvxT);

          if strcmp(model.jacobian,'exact')
                [stochgpx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xpx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          else
                [stochgpx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          end
          
          stochgpx_stochtheta_vecT=ptr1d(col2ptr(ptr2col(ptr2d(unfold(stochgpx_stochtheta_vecT),n_stochy,n_x),1),2));%n_stochy*n_stochtheta,n_x
          %
          [chain1_gp_theta_vecT,model.ind{indi}]=contraction1(stochgpx_stochtheta_vecT,hxT,model.ind{indi},n_ind,maxload,'vec');    
          indi=indi+1;
chain1_gp_theta_vecTa = chain1_gp_theta_vecT;
          chain1_gp_theta_vecT=ptr2col(ptr2d(chain1_gp_theta_vecT,n_stochy,n_stochtheta),2);%n_stochy,n_x,n_stochtheta
          nnzchain1_gp_theta_vecT=col2ptr(changecols(changerows(chain1_gp_theta_vecT,stochy,n_y),stochtheta,(ms+1)*n_theta,2),1); %n_y*n_x,n_theta with only nnz values

          nnzchain1_theta_gpT=col2ptr(changerows(chain1_theta_stochgpT,stochy,n_y),1);% n_y,n_x,n_theta

          vx_theta_lower_terms_vecT=vx_theta_lower_terms;
          vx_theta_lower_terms_vecT.vals=reshape(repmat(vx_theta_lower_terms_vecT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

          if model.hybrid==3
              temp=vconcat(takerows(vx_theta_lower_terms_vecT,1:n_y+n_x1),Phixtheta);
              temp=vconcat(temp,takerows(vx_theta_lower_terms_vecT,n_y+n_x+(1:n_x)));
              vx_theta_lower_terms_vecT=temp;
          end
          
          vx_theta_upper_terms_vecT=unfold(ptr2col(tplus(nnzchain1_theta_gpT,nnzchain1_gp_theta_vecT,maxload),1));
%           clear nnzchain1_theta_gpT nnzchain1_gp_theta_vecT
          vx_theta_vecT=vconcat(vx_theta_upper_terms_vecT,unfold(vx_theta_lower_terms_vecT));

%           clear vx_theta_upper_terms_vecT vx_theta_lower_terms_vecT

          stochvx_theta_vecT=takerows(vx_theta_vecT,stochfvars);

%           clear vx_theta_vecT
    end
    if order>=2
          vxxcT=vxxc;
          if model.hybrid==0 || model.hybrid==1
              stochvxxcT=takerows(vxxcT,stochfvars(n_stochy+1:end));
              stochvxxcT.vals=reshape(repmat(stochvxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
          elseif model.hybrid==3
              vxxcT.vals=reshape(repmat(vxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
              temp=vconcat(takerows(vxxcT,1:2*n_y+n_x1),Phixxc);
              temp=vconcat(temp,takerows(vxxcT,2*n_y+n_x+(1:n_x)));
              vxxcT=temp;
              stochvxxcT=takerows(vxxcT,stochfvars(n_stochy+1:end));
          end

          stochvxxcT=vconcat(chain2_stochgpT,stochvxxcT);

          if strcmp(model.jacobian,'exact')
                [stochgpxx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xpxx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          else
                [stochgpxx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xxx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          end
          
          stochgpxx_stochtheta_vecT=ptr1d(col2ptr(ptr2col(ptr2d(unfold(stochgpxx_stochtheta_vecT),n_stochy,n_x^2),1),2));%n_stochy*n_stochtheta,n_x^2
          stochgpxx_stochtheta_vecT=fold(stochgpxx_stochtheta_vecT,n_x,n_x);

          [chain2c_stochgp_stochtheta_vecT,model.ind{indi}]=chain2c_tensor(stochgpx_stochtheta_vecT,stochgpxx_stochtheta_vecT,...
            hxT,hxxcT,model.ind{indi},n_ind,maxload,'vec');    
          indi=indi+1;
chain2c_stochgp_stochtheta_vecTa = chain2c_stochgp_stochtheta_vecT;
          chain2c_stochgp_stochtheta_vecT=ptr2col(ptr2d(chain2c_stochgp_stochtheta_vecT,n_stochy,n_stochtheta),2);%n_stochy,unique2,n_stochtheta
          nnzchain2c_gp_theta_vecT=col2ptr(changecols(changerows(chain2c_stochgp_stochtheta_vecT,stochy,n_y),stochtheta,(ms+1)*n_theta,2),1); %n_y*unique2,n_theta with only nnz values
          % clear chain2c_stochgp_stochtheta_vecT

          nnzchain2c_theta_gpT=col2ptr(changerows(chain2c_theta_stochgpT,stochy,n_y),1);% n_y,unique2,n_theta

          vxxc_theta_lower_terms_vecT=unfold(vxxc_theta_lower_terms);
          vxxc_theta_lower_terms_vecT.vals=reshape(repmat(vxxc_theta_lower_terms_vecT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

          if model.hybrid==3
              temp=vconcat(takerows(vxxc_theta_lower_terms_vecT,1:n_y+n_x1),unfold(Phixxctheta));
              temp=vconcat(temp,takerows(vxxc_theta_lower_terms_vecT,n_y+n_x+(1:n_x)));
              vxxc_theta_lower_terms_vecT=temp;
          end
          
          vxxc_theta_upper_terms_vecT=unfold(ptr2col(tplus(nnzchain2c_theta_gpT,nnzchain2c_gp_theta_vecT,maxload),1));
%           clear nnzchain2c_theta_gpT nnzchain2c_gp_theta_vecT
          vxxc_theta_vecT=vconcat(vxxc_theta_upper_terms_vecT,vxxc_theta_lower_terms_vecT);

%           clear vxxc_theta_upper_terms_vecT vxxc_theta_lower_terms_vecT

          stochvxxc_theta_vecT=takerows(vxxc_theta_vecT,stochfvars);  

%           clear vxxc_theta_vecT
    end
    if order>=3
          vxxxcT=vxxxc;
          if model.hybrid==0 || model.hybrid==1
              stochvxxxcT=takerows(vxxxcT,stochfvars(n_stochy+1:end));
              stochvxxxcT.vals=reshape(repmat(stochvxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
          elseif model.hybrid==3
              vxxxcT.vals=reshape(repmat(vxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
              temp=vconcat(takerows(vxxxcT,1:2*n_y+n_x1),Phixxxc);
              temp=vconcat(temp,takerows(vxxxcT,2*n_y+n_x+(1:n_x)));
              vxxxcT=temp;
              stochvxxxcT=takerows(vxxxcT,stochfvars(n_stochy+1:end));
          end

          
          stochvxxxcT=vconcat(chain3_stochgpT,stochvxxxcT);

          if strcmp(model.jacobian,'exact')
                [stochgpxxx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xpxxx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          else
                [stochgpxxx_stochtheta_vecT,model.ind{indi}]=tkron(ttranspose(Xxxx_vecT),IstochyT,model.ind{indi},n_ind,maxload,'vec');
                indi=indi+1;
          end

          
          stochgpxxx_stochtheta_vecT=ptr1d(col2ptr(ptr2col(ptr2d(unfold(stochgpxxx_stochtheta_vecT),n_stochy,n_x^3),1),2));%n_stochy*n_stochtheta,n_x^2
          stochgpxxx_stochtheta_vecT=fold(stochgpxxx_stochtheta_vecT,n_x,n_x,n_x);

          [chain3c_stochgp_stochtheta_vecT,model.ind{indi}]=chain3c_tensor(stochgpx_stochtheta_vecT,stochgpxx_stochtheta_vecT,stochgpxxx_stochtheta_vecT,...
                hxT,hxxcT,hxxxcT,...
                model.x_chain3c_M2,...
                model.ind{indi},n_ind,maxload,'vec');    
          indi=indi+1;

          chain3c_stochgp_stochtheta_vecT=ptr2col(ptr2d(chain3c_stochgp_stochtheta_vecT,n_stochy,n_stochtheta),2);%n_stochy,unique3,n_stochtheta
          nnzchain3c_gp_theta_vecT=col2ptr(changecols(changerows(chain3c_stochgp_stochtheta_vecT,stochy,n_y),stochtheta,(ms+1)*n_theta,2),1); %n_y*unique3,n_theta with only nnz values

          % clear chain3c_stochgp_stochtheta_vecT

          nnzchain3c_theta_gpT=col2ptr(changerows(chain3c_theta_stochgpT,stochy,n_y),1);% n_y,unique3,n_theta

          % clear chain3c_theta_stochgpT

          vxxxc_theta_lower_terms_vecT=unfold(vxxxc_theta_lower_terms);
          vxxxc_theta_lower_terms_vecT.vals=reshape(repmat(vxxxc_theta_lower_terms_vecT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

          if model.hybrid==3
              temp=vconcat(takerows(vxxxc_theta_lower_terms_vecT,1:n_y+n_x1),unfold(Phixxxctheta));
              temp=vconcat(temp,takerows(vxxxc_theta_lower_terms_vecT,n_y+n_x+(1:n_x)));
              vxxxc_theta_lower_terms_vecT=temp;
          end          
          
          vxxxc_theta_upper_terms_vecT=unfold(ptr2col(tplus(nnzchain3c_theta_gpT,nnzchain3c_gp_theta_vecT,maxload),1));

          % clear nnzchain3c_theta_gpT nnzchain3c_gp_theta_vecT
          vxxxc_theta_vecT=vconcat(vxxxc_theta_upper_terms_vecT,vxxxc_theta_lower_terms_vecT);

          % clear vxxxc_theta_upper_terms_vecT vxxxc_theta_lower_terms_vecT

          stochvxxxc_theta_vecT=takerows(vxxxc_theta_vecT,stochfvars);    

          % clear vxxxc_theta_vecT
    end
    if order>=4
          vxxxxcT=vxxxxc;
          if model.hybrid==0 || model.hybrid==1
              stochvxxxxcT=takerows(vxxxxcT,stochfvars(n_stochy+1:end));
              stochvxxxxcT.vals=reshape(repmat(stochvxxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
          elseif model.hybrid==3
              vxxxxcT.vals=reshape(repmat(vxxxxcT.vals(:)',n_nodes,1),n_nodes*n_s,[]);
              temp=vconcat(takerows(vxxxxcT,1:2*n_y+n_x1),Phixxxxc);
              temp=vconcat(temp,takerows(vxxxxcT,2*n_y+n_x+(1:n_x)));
              vxxxxcT=temp;
              stochvxxxxcT=takerows(vxxxxcT,stochfvars(n_stochy+1:end));
          end

          stochvxxxxcT=vconcat(chain4_stochgpT,stochvxxxxcT);

          if strcmp(model.jacobian,'exact')
                [stochgpxxxx_stochtheta_vecT,model.ind4{indi4}]=tkron(ttranspose(Xpxxxx_vecT),IstochyT,model.ind4{indi4},n_ind,maxload,'vec');
                indi4=indi4+1;
          else
                [stochgpxxxx_stochtheta_vecT,model.ind4{indi4}]=tkron(ttranspose(Xxxxx_vecT),IstochyT,model.ind4{indi4},n_ind,maxload,'vec');
                indi4=indi4+1;
          end

          
          stochgpxxxx_stochtheta_vecT=ptr1d(col2ptr(ptr2col(ptr2d(unfold(stochgpxxxx_stochtheta_vecT),n_stochy,n_x^4),1),2));%n_stochy*n_stochtheta,n_x^4
          stochgpxxxx_stochtheta_vecT=fold(stochgpxxxx_stochtheta_vecT,n_x,n_x,n_x,n_x);

          [chain4c_stochgp_stochtheta_vecT,model.ind4{indi4}]=chain4c_tensor(stochgpx_stochtheta_vecT,stochgpxx_stochtheta_vecT,stochgpxxx_stochtheta_vecT,stochgpxxxx_stochtheta_vecT,...
                hxT,hxxcT,hxxxcT,hxxxxcT,...
                model.x_chain4c_M2,model.x_chain4c_M3,model.x_chain4c_M4,...
                model.ind4{indi4},n_ind,maxload,'vec');    
          indi4=indi4+1;

          chain4c_stochgp_stochtheta_vecT=ptr2col(ptr2d(chain4c_stochgp_stochtheta_vecT,n_stochy,n_stochtheta),2);%n_stochy,unique4,n_stochtheta
          nnzchain4c_gp_theta_vecT=col2ptr(changecols(changerows(chain4c_stochgp_stochtheta_vecT,stochy,n_y),stochtheta,(ms+1)*n_theta,2),1); %n_y*unique4,n_theta with only nnz values

          % clear chain4c_stochgp_stochtheta_vecT

          nnzchain4c_theta_gpT=col2ptr(changerows(chain4c_theta_stochgpT,stochy,n_y),1);% n_y,unique4,n_theta

          % clear chain4c_theta_stochgpT

          vxxxxc_theta_lower_terms_vecT=unfold(vxxxxc_theta_lower_terms);
          vxxxxc_theta_lower_terms_vecT.vals=reshape(repmat(vxxxxc_theta_lower_terms_vecT.vals(:)',n_nodes,1),n_nodes*n_s,[]);

          if model.hybrid==3
              temp=vconcat(takerows(vxxxxc_theta_lower_terms_vecT,1:n_y+n_x1),unfold(Phixxxxctheta));
              temp=vconcat(temp,takerows(vxxxxc_theta_lower_terms_vecT,n_y+n_x+(1:n_x)));
              vxxxxc_theta_lower_terms_vecT=temp;
          end          
          
          vxxxxc_theta_upper_terms_vecT=unfold(ptr2col(tplus(nnzchain4c_theta_gpT,nnzchain4c_gp_theta_vecT,maxload),1));

          % clear nnzchain4c_theta_gpT nnzchain4c_gp_theta_vecT
          vxxxxc_theta_vecT=vconcat(vxxxxc_theta_upper_terms_vecT,vxxxxc_theta_lower_terms_vecT);

          % clear vxxxxc_theta_upper_terms_vecT vxxxxc_theta_lower_terms_vecT

          stochvxxxxc_theta_vecT=takerows(vxxxxc_theta_vecT,stochfvars);    

          % clear vxxxxc_theta_vecT
    end    
    totindi=totindi+9;
    indi=totindi;

    [ EstochJ0,model.ind{indi} ] = chain0_theta_tensor( stochfv_vec,stochv_theta_vecT,model.ind{indi},n_ind,maxload,'vec' );
    indi=indi+1;

    EstochJ0.vals=reshape(sum(reshape(EstochJ0.vals,n_nodes,[]),1),n_s,[]);

    if order>=1
        [ EstochR1,model.ind{indi} ] = chain1_tensor( stochfv_vec,stochvxT,model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochR1.vals=reshape(sum(reshape(EstochR1.vals,n_nodes,[]),1),n_s,[]);



        [ EstochJ1,model.ind{indi} ] = chain1_theta_tensor( stochfv_vec,stochfvv_vec,...
            stochvxT,stochv_theta_vecT,stochvx_theta_vecT,...
            model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochJ1.vals=reshape(sum(reshape(EstochJ1.vals,n_nodes,[]),1),n_s,[]);
    end
    if order>=2
        [stochvxT,model.ind4{indi4}]=colsort(stochvxT,model.ind4{indi4});
        indi4=indi4+1;
        [ EstochR2,model.ind{indi} ] = chain2c_tensor( stochfv_vec,stochfvv_vec,...
            stochvxT,stochvxxcT,model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochR2.vals=reshape(sum(reshape(EstochR2.vals,n_nodes,[]),1),n_s,[]);

        [ EstochJ2,model.ind{indi} ] = chain2c_theta_tensor( stochfv_vec,stochfvv_vec,stochfvvv_vec,...
            stochvxT,stochvxxcT,...
            stochv_theta_vecT,stochvx_theta_vecT,stochvxxc_theta_vecT,...
            model.chain2c_theta_M2,...
            model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochJ2.vals=reshape(sum(reshape(EstochJ2.vals,n_nodes,[]),1),n_s,[]);
    end
    if order>=3
        [ EstochR3,model.ind{indi} ] = chain3c_tensor( stochfv_vec,stochfvv_vec,stochfvvv_vec,...
            stochvxT,stochvxxcT,stochvxxxcT,...
            model.x_chain3c_M2,...
            model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochR3.vals=reshape(sum(reshape(EstochR3.vals,n_nodes,[]),1),n_s,[]);

        [ EstochJ3,model.ind{indi} ] = chain3c_theta_tensor( stochfv_vec,stochfvv_vec,stochfvvv_vec,stochfvvvv_vec,...
            stochvxT,stochvxxcT,stochvxxxcT,...
            stochv_theta_vecT,stochvx_theta_vecT,stochvxxc_theta_vecT,stochvxxxc_theta_vecT,...
            model.chain3c_theta_M2,model.chain3c_theta_M3,model.chain3c_theta_M4,model.chain3c_theta_M5,...
            model.ind{indi},n_ind,maxload,'vec' );
        indi=indi+1;
        EstochJ3.vals=reshape(sum(reshape(EstochJ3.vals,n_nodes,[]),1),n_s,[]);
    end
    if order>=4
        [stochvxxcT,model.ind4{indi4}]=colsort(stochvxxcT,model.ind4{indi4});
        indi4=indi4+1;        
        [ EstochR4,model.ind4{indi4} ] = chain4c_tensor( stochfv_vec,stochfvv_vec,stochfvvv_vec,stochfvvvv_vec,...
            stochvxT,stochvxxcT,stochvxxxcT,stochvxxxxcT,...
            model.x_chain4c_M2,model.x_chain4c_M3,model.x_chain4c_M4,...
            model.ind4{indi4},n_ind,maxload,'vec' );
        indi4=indi4+1;
        EstochR4.vals=reshape(sum(reshape(EstochR4.vals,n_nodes,[]),1),n_s,[]);

        [ EstochJ4,model.ind4{indi4} ] = chain4c_theta_tensor( stochfv_vec,stochfvv_vec,stochfvvv_vec,stochfvvvv_vec,stochfvvvvv_vec,...
            stochvxT,stochvxxcT,stochvxxxcT,stochvxxxxcT,...
            stochv_theta_vecT,stochvx_theta_vecT,stochvxxc_theta_vecT,stochvxxxc_theta_vecT,stochvxxxxc_theta_vecT,...
            model.chain4c_theta_M2,model.chain4c_theta_M3,model.chain4c_theta_M5,model.chain4c_theta_M6,model.chain4c_theta_M9,model.chain4c_theta_M10,...
            model.ind4{indi4},n_ind,maxload,'vec' );
        indi4=indi4+1;
        EstochJ4.vals=reshape(sum(reshape(EstochJ4.vals,n_nodes,[]),1),n_s,[]);
    end
    totindi=totindi+7;
end

% build the system and the Jacobian

R0=vconcat(preR0,EstochR0);
oldrows=1:R0.tsize(1);
newrows=zeros(1,R0.tsize(1));
newrows([model.prefrows(:);model.stochfrows(:)])=oldrows;
R0=permuterows(R0,newrows);

J0=vconcat(preJ0,EstochJ0);
J0=permuterows(J0,newrows);



T=R0;
J=J0;

if order>=1
    R1=vconcat(preR1,EstochR1);
    R1=permuterows(R1,newrows);
    
    R1=ptr2d(R1,1,n_f);
    R1=ptr2col(R1,1);
    R1=fold(unfold(R1),n_f*n_x,1);   
    R1=ptr1d(col2ptr(R1,1));

    T=vconcat(T,R1);
    
    J1=vconcat(preJ1,EstochJ1);
    J1=permuterows(J1,newrows);
    
    J1=ptr2d(J1,1,n_f);
    J1=ptr2col(J1,1);
    J1=fold(unfold(J1),n_f*n_x,(ms+1)*n_theta);   
    J1=ptr1d(col2ptr(J1,1));
    
    J=vconcat(J,J1);
end
if order>=2
    R2=vconcat(preR2,EstochR2);
    R2=permuterows(R2,newrows);

    R2=ptr2d(R2,1,n_f);
    R2=ptr2col(R2,1);
    R2=fold(unfold(R2),n_f*unique2,1);   
    R2=ptr1d(col2ptr(R2,1));

    T=vconcat(T,R2);
    
    J2=vconcat(preJ2,EstochJ2);
    J2=permuterows(J2,newrows);
    
    J2=ptr2d(J2,1,n_f);
    J2=ptr2col(J2,1);
    J2=fold(unfold(J2),n_f*unique2,(ms+1)*n_theta);   
    J2=ptr1d(col2ptr(J2,1));

    J=vconcat(J,J2);
end
if order>=3
    R3=vconcat(preR3,EstochR3);
    R3=permuterows(R3,newrows);
    
    R3=ptr2d(R3,1,n_f);
    R3=ptr2col(R3,1);
    R3=fold(unfold(R3),n_f*unique3,1);   
    R3=ptr1d(col2ptr(R3,1));

    T=vconcat(T,R3);

    J3=vconcat(preJ3,EstochJ3);
    J3=permuterows(J3,newrows);
    
    J3=ptr2d(J3,1,n_f);
    J3=ptr2col(J3,1);
    J3=fold(unfold(J3),n_f*unique3,(ms+1)*n_theta);   
    J3=ptr1d(col2ptr(J3,1));

    J=vconcat(J,J3);

end
if order>=4
    R4=vconcat(preR4,EstochR4);
    R4=permuterows(R4,newrows);
    
    R4=ptr2d(R4,1,n_f);
    R4=ptr2col(R4,1);
    R4=fold(unfold(R4),n_f*unique4,1);   
    R4=ptr1d(col2ptr(R4,1));

    T=vconcat(T,R4);

    J4=vconcat(preJ4,EstochJ4);
    J4=permuterows(J4,newrows);
    
    J4=ptr2d(J4,1,n_f);
    J4=ptr2col(J4,1);
    J4=fold(unfold(J4),n_f*unique4,(ms+1)*n_theta);   
    J4=ptr1d(col2ptr(J4,1));

    J=vconcat(J,J4);

end
model.coeffs=coeffs;
model.nv=nv;
model.v_theta=v_theta;

if isfield(model,'special_code')
    eval(model.special_code);
end

end