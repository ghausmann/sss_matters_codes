function [R0,g,h1,nPhi,nu_vec,model]=eval_modelMS_vec(coeffs,x0,model,params,msparams,transition,c0,nep,P,varargin)

% INPUTS:
% coeffs (n_s,n_endog*n_b*n_regimes,n_regimes)
% x0 (n_s,n_x)
% params (n_s,n_params)
% msparams (n_msparams,n_regimes)

% if size(coeffs,1)~=model.n_theta || size(coeffs,2)~=model.n_regimes
%     message=sprintf(['The first argument is wrong. The initial guess should be a ' num2str(model.n_theta) '-by-' num2str(model.n_regimes) ' matrix.  \nThe number of polynomial coefficients per regime is ' num2str(model.n_theta) ' and the number of regimes is ' num2str(model.n_regimes)'.']);
%     error(message);
% end
% x0=x0(:);
% if length(x0)~=model.n_x
%     error(['The second argument is wrong. The approximation point should be a vector of' num2str(model.n_x) ' elements (=the number of state variables).'])
% end
% if ~isstruct(model)
%     error('The third argument is wrong. It should be a structure generated by prepare_tpMS.')
% elseif ~isfield(model,'n_x')
%     error('The third argument is wrong. It should be a structure generated by prepare_tpMS.')
% end
% params=params(:);
% if length(params)~=model.n_params_no_ms
%     error(['The fourth argument is wrong. The number of model parameters should be ' num2str(model.n_params_no_ms) '.'])
% end
% if isempty(msparams)
%     msparams=zeros(0,model.n_regimes);
% end
% if size(msparams,1)~=model.n_msparams || size(msparams,2)~=model.n_regimes
%     error(sprintf(['The fifth argument is wrong. It should be a ' num2str(model.n_msparams) '-by-' num2str(model.n_regimes) ' matrix. \nThe number of Markov switching parameters is ' num2str(model.n_msparams) ' and the number of regimes is ' num2str(model.n_regimes) '.']))
% end
% if size(transition,1)~=model.n_regimes || size(transition,2)~=model.n_regimes
%     error(['The sixth argument is wrong. The transition matrix should have ' num2str(model.n_regimes) ' rows and columns.'])
% end
% c0=c0(:);
% if length(c0)~=model.n_x
%     error(['The seventh argument is wrong. The center of the approximating polynomial should be a vector of' num2str(model.n_x) ' elements (=the number of state variables).'])
% end
% if size(nep,1)~=model.n_e
%     error(['The eighth argument is wrong. It should be a matrix with ' num2str(model.n_e) ' rows (=the number of shocks).'])
% end
% P=P(:);
% if size(nep,2)~=length(P)
%     error('The eighth or ninth arguments are wrong. The number of columns in the eighth argument should be equal to the number of elements in the ninth argument.')
% end

% if isempty(varargin)

if numel(x0)==model.n_x && numel(coeffs)==model.n_theta*model.n_regimes && numel(params)==model.n_params
    n_s=1;
else % x0,coeffs,params have a row dimension of 1 or n_s
    temp=[size(x0,1),size(coeffs,1),size(params,1),size(c0,1)];
    n_s=max(temp);
    if min(temp)~=n_s
        error('incompatible s dimension')
    end
end

% if ~isequal(x0,c0)
%     error('x0 must be equal to c0')
% end

% msparams should have n_regimes columns

if size(msparams,2)~=model.n_regimes
    error('msparams should have n_regimes columns')
end

msparams=msparams'; %n_regimes,n_msparams

paramsvec=reshape(repmat(params(:)',model.n_regimes^2,1),model.n_regimes^2*n_s,[]); % n_regimes*n_regimes,n_s*n_params

[s,sp]=ndgrid([1:model.n_regimes],[1:model.n_regimes]);
s=s(:);
sp=sp(:);
paramsvec=[paramsvec,repmat([msparams(s,:),msparams(sp,:)],n_s,1)]; 

coeffs=reshape(full(coeffs),n_s*model.n_theta,model.n_regimes);
coeffsvec=coeffs(:,s);
coeffsvec=reshape(coeffsvec,n_s,model.n_theta,model.n_regimes^2);
coeffsvec=permute(coeffsvec,[3,1,2]);
coeffsvec=reshape(coeffsvec,model.n_regimes^2*n_s,[]);

coeffspvec=coeffs(:,sp);
coeffspvec=reshape(coeffspvec,n_s,model.n_theta,model.n_regimes^2);
coeffspvec=permute(coeffspvec,[3,1,2]);
coeffspvec=reshape(coeffspvec,model.n_regimes^2*n_s,[]);


x0vec=repmat(x0(:)',model.n_regimes^2,1); %n_regimes^2,n_s*n_x
x0vec=reshape(x0vec,model.n_regimes^2*n_s,[]); %n_regimes^2*n_s,n_x
c0vec=repmat(c0(:)',model.n_regimes^2,1); %n_regimes^2,n_s*n_x
c0vec=reshape(c0vec,model.n_regimes^2*n_s,[]); %n_regimes^2*n_s,n_x

nep=full(nep);
P=full(P);
% row dimensions should be n_regimes*n_regimes*n_s

    [R0,g,h1,nPhi,nu_vec,model]=eval_model_vec(coeffsvec,x0vec,model,paramsvec,c0vec,nep,P,coeffspvec);

    ny=reshape(g.vals,model.n_regimes,model.n_regimes,n_s,[]);
    ny=ny(:,1,:,:);
    g=reshape(ny,model.n_regimes,n_s,model.n_y);
    g=permute(g,[2,3,1]); %n_s,n_y,n_regimes

    nx1=reshape(h1.vals,model.n_regimes,model.n_regimes,n_s,[]);
    nx1=nx1(:,1,:,:);
    h1=reshape(nx1,model.n_regimes,n_s,model.n_x1);
    h1=permute(h1,[2,3,1]);

    nPhi=reshape(nPhi,model.n_regimes,model.n_regimes,n_s,[]);
    nPhi=nPhi(:,1,:,:);
    nPhi=reshape(nPhi,model.n_regimes,n_s,model.n_x2);
    nPhi=permute(nPhi,[2,3,1]);
    
    n_nodes=length(P);
    nu_vec=reshape(nu_vec,n_nodes,model.n_regimes,model.n_regimes,n_s,model.n_u); % n_nodes,s,sp,n_s,n_u
    nu_vec=permute(nu_vec,[4,5,1,2,3]);
    
    % sum across sp
    R0=reshape(R0,model.n_regimes,model.n_regimes,[]);
    R0=R0.*reshape(repmat(transition,1,size(R0,3)),model.n_regimes,model.n_regimes,size(R0,3));
    R0=reshape(sum(R0,2),model.n_regimes,n_s,[]);
    R0=permute(R0,[2,3,1]);
    R0=reshape(R0,n_s,[]);

%     R0=R0(:);

% else
%     
%     regime=varargin{1};
%     if numel(regime)>1
%         error('only 1 regime is allowed')
%     end
% 
%     msparams=msparams';
% 
%     paramsvec=repmat(params(:)',model.n_regimes,1); % n_regimes*n_regimes,[]
% 
%     s=repmat(regime,model.n_regimes,1);
%     sp=(1:model.n_regimes)';
%     paramsvec=[paramsvec,msparams(s,:),msparams(sp,:)]; %n_s,n_sp,n_params
% 
%     coeffs=reshape(full(coeffs),model.n_theta,model.n_regimes);
%     coeffsvec=coeffs(:,s)';
%     coeffspvec=coeffs(:,sp)';
% 
%     x0vec=repmat(x0(:)',model.n_regimes,1);
%     c0vec=repmat(c0(:)',model.n_regimes,1);
% 
%     nep=full(nep);
%     P=full(P);
% 
%     [R0,g,h1,nPhi,nu_vec,model]=eval_model_vec(coeffsvec,x0vec,model,paramsvec,c0vec,nep,P,coeffspvec);
% 
%     ny=reshape(g.vals,1,model.n_regimes,[]);
%     ny=ny(:,1,:);
%     g=squeeze(ny);
% 
%     nx1=reshape(h1.vals,1,model.n_regimes,[]);
%     nx1=nx1(:,1,:);
%     h1=squeeze(nx1);
% 
%     nPhi=reshape(nPhi,1,model.n_regimes,[]);
%     nPhi=nPhi(:,1,:);
%     nPhi=squeeze(nPhi);
%     
%     n_nodes=length(P);
%     nu_vec=reshape(nu_vec,n_nodes,model.n_regimes,model.n_u); % n_nodes,sp,n_u
%     nu_vec=permute(nu_vec,[3,2,1]);
%     % sum across sp
%     R0=reshape(R0,1,model.n_regimes,[]);
%     R0=R0.*reshape(repmat(transition(regime,:),1,size(R0,3)),1,model.n_regimes,size(R0,3));
% 
%     R0=reshape(sum(R0,2),1,[]);
% 
%     R0=R0(:);
%     
% end

end